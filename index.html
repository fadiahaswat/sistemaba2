<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIAP! - Sistem Informasi Aba-aba Peleton</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG0C+wFjr8bCqwA2ag==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
            color: #1e293b; /* slate-800 */
        }
        
        .card {
            background-color: #ffffff;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }

        .form-input {
            background-color: transparent;
            border-color: #cbd5e1; /* slate-300 */
        }
        .form-input:focus {
            --tw-ring-color: #fb7185; /* rose-400 */
            background-color: #f1f5f9; /* slate-100 */
        }

        /* Modern Skeuomorphism & 3D Button Effect */
        .btn {
            position: relative;
            border-radius: 0.75rem; /* 12px */
            border: 1px solid rgba(0,0,0,0.1);
            border-bottom: 4px solid rgba(0,0,0,0.2);
            transition: all 0.1s ease-in-out;
            transform-style: preserve-3d;
        }
        .btn:hover {
            transform: translateY(-2px);
            border-bottom-width: 6px;
        }
        .btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }
        .btn-primary {
            background-color: #9f1239; /* rose-800 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #881337; /* rose-900 */
        }
        .btn-action:disabled {
            background-color: #d6d3d1; /* stone-300 */
            color: #78716c; /* stone-500 */
            cursor: not-allowed;
            transform: none;
            border-bottom-width: 4px;
            opacity: 0.8;
        }
        
        .modal-backdrop {
            background-color: rgba(17, 24, 39, 0.5);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
        }

        .anim-pop-in { animation: popIn 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .anim-fade-out { animation: fadeOut 0.3s ease-out forwards; }
        @keyframes fadeOut {
            to { opacity: 0; transform: scale(0.95); height: 0; padding: 0; margin: 0; border: none; }
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="relative text-center py-8 sm:py-12">
            <div class="mx-auto mb-6 w-20 h-20 rounded-3xl bg-gradient-to-br from-rose-700 to-rose-900 text-white flex items-center justify-center text-4xl shadow-2xl shadow-rose-200">
                <p class="font-black">S!</p>
            </div>
            <h1 class="text-4xl sm:text-5xl md:text-6xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-slate-900 to-slate-700">
                SIAP!
            </h1>
            <p class="mt-2 text-lg sm:text-xl font-semibold text-rose-800">
                Sistem Informasi Aba-aba Peleton
            </p>
            <p class="mt-4 text-base sm:text-lg text-slate-600 max-w-3xl mx-auto">
                Aplikasi digital untuk menyusun, menyimpan, dan melatih aba-aba baris-berbaris secara praktis dan terstruktur.
            </p>
        </header>

        <!-- Global Details -->
        <div class="card p-6 rounded-2xl shadow-xl mb-8">
            <h2 class="text-xl font-bold mb-4 text-rose-800">Detail Informasi Aba-aba</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="plan-title" placeholder="Nama Aba-aba (cth: Latihan PBB Dasar)" class="form-input w-full p-3 border rounded-lg">
                <input type="text" id="plan-description" placeholder="Deskripsi (cth: Latihan rutin mingguan)" class="form-input w-full p-3 border rounded-lg">
                <input type="date" id="plan-date" class="form-input w-full p-3 border rounded-lg text-slate-500">
                <input type="text" id="plan-location" placeholder="Lokasi (cth: Lapangan Utama)" class="form-input w-full p-3 border rounded-lg">
            </div>
        </div>
        
        <!-- AI Helper / Status Box -->
        <div id="helper-box" class="bg-sky-100 border-l-4 border-sky-500 text-sky-800 p-4 rounded-r-lg mb-8 transition-all duration-300">
            <div class="flex">
                <div class="py-1"><span class="text-2xl">ðŸ’¡</span></div>
                <div class="ml-3">
                    <p class="font-bold">Asisten SIAP!</p>
                    <p id="helper-text" class="text-sm">Mulai dengan menambahkan pos, lalu isi detail dan materinya. Tombol Salin & Ekspor akan aktif jika data sudah lengkap.</p>
                </div>
            </div>
        </div>
        
        <!-- Manual Copy Fallback Area -->
        <div id="manual-copy-area" class="hidden mb-8">
            <textarea id="manual-copy-textarea" readonly class="w-full h-48 p-3 border-2 border-dashed border-slate-400 rounded-lg bg-slate-50"></textarea>
        </div>

        <!-- Posts Container -->
        <div id="posts-container" class="space-y-8"></div>
        
        <!-- Action Buttons -->
        <div class="mt-8 flex flex-col sm:flex-row gap-4">
            <button id="add-post-btn" class="btn btn-primary font-bold py-3 px-4 text-base flex-grow flex items-center justify-center gap-2">
                <span class="text-xl">âž•</span> Tambah Pos Baru
            </button>
            <button id="copy-text-btn" class="btn btn-action bg-sky-600 text-white font-bold py-3 px-4 text-base flex items-center justify-center gap-2 hover:bg-sky-700 transition-all duration-200">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" /></svg>
                Salin Teks
            </button>
            <button id="export-pdf-btn" class="btn btn-action bg-green-600 text-white font-bold py-3 px-4 text-base flex items-center justify-center gap-2 hover:bg-green-700 transition-all duration-200">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                Ekspor ke PDF
            </button>
        </div>
    </div>

    <!-- Modals Container -->
    <div id="modal-container"></div>
    <!-- Printable Area (Hidden) -->
    <div id="print-area"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA ---
        const PBB_COMMANDS = [
            { category: 'Sikap Sempurna & Istirahat', items: [ { id: 'siap_gerak', text: 'Siap = GERAK!' }, { id: 'parade_siap_gerak', text: 'Parade, Siap = GERAK!' }, { id: 'duduk_siap_gerak', text: 'Duduk Siap = GERAK!' }, { id: 'istirahat_ditempat_gerak', text: 'Istirahat di Tempat = GERAK!' }, { id: 'parade_istirahat_ditempat_gerak', text: 'Parade, Istirahat di Tempat = GERAK!' }, { id: 'untuk_perhatian', text: 'Untuk Perhatian!' } ] },
            { category: 'Lencang & Tegak', items: [ { id: 'lencang_kanan_gerak', text: 'Lencang Kanan = GERAK!' }, { id: 'lencang_kiri_gerak', text: 'Lencang Kiri = GERAK!' }, { id: 'setengah_lengan_lencang_kanan_gerak', text: 'Setengah Lengan Lencang Kanan = GERAK!' }, { id: 'setengah_lengan_lencang_kiri_gerak', text: 'Setengah Lengan Lencang Kiri = GERAK!' }, { id: 'lencang_depan_gerak', text: 'Lencang Depan = GERAK!' }, { id: 'tegak_gerak', text: 'Tegak = GERAK!' } ] },
            { category: 'Penghormatan', items: [ { id: 'hormat_gerak', text: 'Hormat = GERAK!' }, { id: 'hormat_kanan_gerak', text: 'Hormat Kanan = GERAK!' }, { id: 'hormat_kiri_gerak', text: 'Hormat Kiri = GERAK!' } ] },
            { category: 'Berhitung', items: [ { id: 'hitung_mulai', text: 'Hitung = MULAI!' } ] },
            { category: 'Periksa Kerapihan', items: [ { id: 'periksa_kerapian_mulai', text: 'Periksa Kerapian = MULAI!' }, { id: 'periksa_kerapian_selesai', text: 'SELESAI!' }, { id: 'parade_periksa_kerapian_mulai', text: 'Parade Periksa Kerapian = MULAI!' } ] },
            { category: 'Buka & Tutup Barisan', items: [ { id: 'buka_barisan_jalan', text: 'Buka Barisan = JALAN!' }, { id: 'tutup_barisan_jalan', text: 'Tutup Barisan = JALAN!' } ] },
            { category: 'Perubahan Arah (Di Tempat)', items: [ { id: 'hadap_kanan_gerak', text: 'Hadap Kanan = GERAK!' }, { id: 'hadap_kiri_gerak', text: 'Hadap Kiri = GERAK!' }, { id: 'hadap_serong_kanan_gerak', text: 'Hadap Serong Kanan = GERAK!' }, { id: 'hadap_serong_kiri_gerak', text: 'Hadap Serong Kiri = GERAK!' }, { id: 'balik_kanan_gerak', text: 'Balik Kanan = GERAK!' } ] },
            { category: 'Bubar', items: [ { id: 'bubar_jalan', text: 'Bubar = JALAN!' } ] },
            { category: 'Jalan di Tempat', items: [ { id: 'jalan_ditempat_gerak', text: 'Jalan di Tempat = GERAK!' }, { id: 'henti_gerak_ditempat', text: 'Henti = GERAK!' } ] },
            { category: 'Gerakan Berjalan (Mulai & Berhenti)', items: [
                { id: 'maju_jalan', text: 'Maju = JALAN!' },
                { id: 'langkah_tegap_maju_jalan', text: 'Langkah Tegap Maju = JALAN!' },
                { id: 'langkah_perlahan_maju_jalan', text: 'Langkah Perlahan Maju = JALAN!' },
                { id: 'langkah_ke_kanan_jalan', text: 'Langkah ke Kanan = JALAN!', needsInput: true },
                { id: 'langkah_ke_kiri_jalan', text: 'Langkah ke Kiri = JALAN!', needsInput: true },
                { id: 'langkah_ke_belakang_jalan', text: 'Langkah ke Belakang = JALAN!', needsInput: true },
                { id: 'langkah_ke_depan_jalan', text: 'Langkah ke Depan = JALAN!', needsInput: true },
                { id: 'henti_gerak_berjalan', text: 'Henti = GERAK!' },
            ]},
            { category: 'Gerakan Berlari (Mulai & Berhenti)', items: [
                { id: 'lari_maju_jalan', text: 'Lari Maju = JALAN!' },
                { id: 'lari_jalan', text: 'Lari = JALAN!' },
                { id: 'henti_gerak_berlari', text: 'Henti = GERAK!' },
            ]},
            { category: 'Gerakan Transisi (Berjalan & Berlari)', items: [
                { id: 'langkah_tegap_jalan', text: 'Langkah Tegap = JALAN!' },
                { id: 'langkah_biasa_jalan', text: 'Langkah Biasa = JALAN!' },
                { id: 'langkah_perlahan_jalan', text: 'Langkah Perlahan = JALAN!' },
                { id: 'langkah_merdeka_jalan', text: 'Langkah Merdeka = JALAN!' },
                { id: 'ganti_langkah_jalan', text: 'Ganti Langkah = JALAN!' },
            ]},
            { category: 'Perubahan Arah (Berjalan)', items: [
                { id: 'hadap_kanan_maju_jalan', text: 'Hadap Kanan Maju = JALAN!' },
                { id: 'hadap_kiri_maju_jalan', text: 'Hadap Kiri Maju = JALAN!' },
                { id: 'hadap_serong_kanan_maju_jalan', text: 'Hadap Serong Kanan Maju = JALAN!' },
                { id: 'hadap_serong_kiri_maju_jalan', text: 'Hadap Serong Kiri Maju = JALAN!' },
                { id: 'balik_kanan_maju_jalan', text: 'Balik Kanan Maju = JALAN!' },
                { id: 'belok_kanan_jalan', text: 'Belok Kanan = JALAN!' },
                { id: 'belok_kiri_jalan', text: 'Belok Kiri = JALAN!' },
                { id: 'dua_kali_belok_kanan_jalan', text: 'Dua Kali Belok Kanan = JALAN!' },
                { id: 'dua_kali_belok_kiri_jalan', text: 'Dua Kali Belok Kiri = JALAN!' },
                { id: 'tiap_tiap_banjar_2x_belok_kanan_jalan', text: 'Tiap-tiap Banjar Dua Kali Belok Kanan = JALAN!' },
                { id: 'tiap_tiap_banjar_2x_belok_kiri_jalan', text: 'Tiap-tiap Banjar Dua Kali Belok Kiri = JALAN!' },
            ]},
            { category: 'Perubahan Arah (Berjalan ke Berhenti)', items: [
                { id: 'hadap_kanan_henti_gerak', text: 'Hadap Kanan Henti = GERAK!' },
                { id: 'hadap_kiri_henti_gerak', text: 'Hadap Kiri Henti = GERAK!' },
                { id: 'hadap_serong_kanan_henti_gerak', text: 'Hadap Serong Kanan Henti = GERAK!' },
                { id: 'hadap_serong_kiri_henti_gerak', text: 'Hadap Serong Kiri Henti = GERAK!' },
                { id: 'balik_kanan_henti_gerak', text: 'Balik Kanan Henti = GERAK!' },
            ]},
             { category: 'Perubahan Arah (Berlari)', items: [
                { id: 'hadap_kanan_lari_maju_jalan', text: 'Hadap Kanan Lari Maju = JALAN!' },
                { id: 'hadap_kiri_lari_maju_jalan', text: 'Hadap Kiri Lari Maju = JALAN!' },
                { id: 'hadap_serong_kanan_lari_maju_jalan', text: 'Hadap Serong Kanan Lari Maju = JALAN!' },
                { id: 'hadap_serong_kiri_lari_maju_jalan', text: 'Hadap Serong Kiri Lari Maju = JALAN!' },
                { id: 'balik_kanan_lari_maju_jalan', text: 'Balik Kanan Lari Maju = JALAN!' },
            ]},
             { category: 'Perubahan Arah (Berlari ke Berhenti)', items: [
                { id: 'hadap_kanan_lari_henti_gerak', text: 'Hadap Kanan Henti = GERAK!' },
                { id: 'hadap_kiri_lari_henti_gerak', text: 'Hadap Kiri Henti = GERAK!' },
                { id: 'hadap_serong_kanan_lari_henti_gerak', text: 'Hadap Serong Kanan Henti = GERAK!' },
                { id: 'hadap_serong_kiri_lari_henti_gerak', text: 'Hadap Serong Kiri Henti = GERAK!' },
                { id: 'balik_kanan_lari_henti_gerak', text: 'Balik Kanan Henti = GERAK!' },
            ]},
            { category: 'Haluan & Melintang', items: [
                { id: 'haluan_kanan_jalan', text: 'Haluan Kanan = JALAN!' },
                { id: 'haluan_kiri_jalan', text: 'Haluan Kiri = JALAN!' },
                { id: 'haluan_kanan_maju_jalan', text: 'Haluan Kanan Maju = JALAN!' },
                { id: 'haluan_kiri_maju_jalan', text: 'Haluan Kiri Maju = JALAN!' },
                { id: 'melintang_kanan_jalan', text: 'Melintang Kanan = JALAN!' },
                { id: 'melintang_kiri_jalan', text: 'Melintang Kiri = JALAN!' },
                { id: 'melintang_kanan_maju_jalan', text: 'Melintang Kanan Maju = JALAN!' },
                { id: 'melintang_kiri_maju_jalan', text: 'Melintang Kiri Maju = JALAN!' },
            ]},
            { category: 'Berhimpun & Berkumpul', items: [
                { id: 'berhimpun_mulai', text: 'Berhimpun = MULAI!' },
                { id: 'bersaf_kumpul_mulai', text: 'Bersaf Kumpul = MULAI!' },
                { id: 'berbanjar_kumpul_mulai', text: 'Berbanjar Kumpul = MULAI!' },
                { id: 'selesai_himpun_kumpul', text: 'SELESAI!' }
            ]}
        ];

        // --- STATE ---
        let plan = { title: '', description: '', date: '', location: '', posts: [] };
        let currentTargetMaterialId = null;

        // --- DOM ELEMENTS ---
        const postsContainer = document.getElementById('posts-container');
        const modalContainer = document.getElementById('modal-container');
        const copyTextBtn = document.getElementById('copy-text-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const helperText = document.getElementById('helper-text');
        const manualCopyArea = document.getElementById('manual-copy-area');
        const manualCopyTextarea = document.getElementById('manual-copy-textarea');
        
        // --- FUNCTIONS ---
        const showToast = (message) => {
            const toastEl = document.createElement('div');
            toastEl.className = "fixed bottom-5 right-5 bg-slate-900 text-white py-3 px-6 rounded-lg shadow-xl transition-all duration-300 transform translate-y-24 opacity-0 z-[100]";
            toastEl.innerHTML = `<p>${message}</p>`;
            document.body.appendChild(toastEl);
            requestAnimationFrame(() => {
                toastEl.classList.remove('translate-y-24', 'opacity-0');
            });
            setTimeout(() => {
                toastEl.classList.add('translate-y-24', 'opacity-0');
                toastEl.addEventListener('transitionend', () => toastEl.remove());
            }, 3000);
        };
        
        const updateActionButtonsState = () => {
            const isPlanValid = plan.posts.length > 0 && plan.posts.some(post => 
                post.size_p && post.size_l && post.time && post.materials.length > 0
            );
            copyTextBtn.disabled = !isPlanValid;
            exportPdfBtn.disabled = !isPlanValid;
            
            manualCopyArea.classList.add('hidden');
            if (isPlanValid) {
                 helperText.textContent = "Rencana sudah lengkap! Anda sekarang dapat menyalin teks atau mengekspor ke PDF.";
            } else {
                 helperText.textContent = "Tombol Salin & Ekspor akan aktif jika data pos (Panjang, Lebar, Waktu) dan setidaknya satu materi sudah terisi.";
            }
        };

        const renderPlan = () => {
            postsContainer.innerHTML = '';
            if (plan.posts.length === 0) {
                postsContainer.innerHTML = `<div class="text-center py-16 bg-white rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold">Rencana Masih Kosong</h3>
                    <p class="mt-2 text-slate-500">Klik tombol "âž• Tambah Pos Baru" untuk memulai.</p>
                </div>`;
            }
            plan.posts.forEach((post, index) => {
                const postEl = document.createElement('div');
                postEl.className = "card relative p-4 sm:p-6 rounded-2xl shadow-xl anim-pop-in";
                postEl.dataset.postId = post.id;

                let posTitleHTML = plan.posts.length > 1 
                    ? `<h2 class="text-2xl font-bold text-rose-800">POS ${index + 1}</h2>`
                    : `<input type="text" value="${post.name}" data-field="name" placeholder="Nama Pos" class="text-2xl font-bold text-rose-800 bg-transparent focus:bg-slate-100 rounded p-2 w-full">`;

                postEl.innerHTML = `
                    <button class="delete-post-btn absolute top-3 right-3 text-slate-400 hover:text-red-500 transition-colors z-10" title="Hapus Pos Ini">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                        <div class="lg:col-span-2 bg-slate-50 p-4 rounded-lg flex flex-col justify-center">
                            ${posTitleHTML}
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-center bg-slate-50 p-4 rounded-lg">
                            <div class="flex flex-col items-center justify-center">
                                <span class="font-semibold text-sm text-slate-500">Panjang</span>
                                <div class="flex items-baseline gap-1 mt-1">
                                    <input type="number" value="${post.size_p}" data-field="size_p" placeholder="0" class="w-full font-bold text-xl bg-transparent text-center focus:outline-none">
                                    <span class="text-sm">m</span>
                                </div>
                            </div>
                            <div class="flex flex-col items-center justify-center">
                                <span class="font-semibold text-sm text-slate-500">Lebar</span>
                                <div class="flex items-baseline gap-1 mt-1">
                                    <input type="number" value="${post.size_l}" data-field="size_l" placeholder="0" class="w-full font-bold text-xl bg-transparent text-center focus:outline-none">
                                    <span class="text-sm">m</span>
                                </div>
                            </div>
                            <div class="flex flex-col items-center justify-center">
                                <span class="font-semibold text-sm text-slate-500">Waktu</span>
                                <div class="flex items-baseline gap-1 mt-1">
                                    <input type="number" value="${post.time}" data-field="time" placeholder="0" class="w-full font-bold text-xl bg-transparent text-center focus:outline-none">
                                    <span class="text-sm">min</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr class="my-4 border-slate-200">
                    <div class="materials-container space-y-2"></div>
                    <div class="mt-4 flex flex-wrap gap-2">
                        <button data-type="numbered" class="add-material-option flex-grow bg-rose-100 text-rose-800 font-semibold py-2 px-4 rounded-lg hover:bg-rose-200 transition">+ Baris Materi</button>
                        <button data-type="adjustment" class="add-material-option p-2 rounded-lg bg-slate-200 hover:bg-slate-300" title="Gerakan Penyesuaian"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg></button>
                        <button data-type="report" class="add-material-option p-2 rounded-lg bg-slate-200 hover:bg-slate-300" title="Laporan"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 1.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" /></svg></button>
                        <button data-type="start_end" class="add-material-option p-2 rounded-lg bg-slate-200 hover:bg-slate-300" title="Materi Mulai/Selesai"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg></button>
                    </div>
                `;
                postsContainer.appendChild(postEl);
                renderMaterials(postEl, post);
            });
            updateActionButtonsState();
        };

        const renderMaterials = (postEl, postData) => {
            const materialsContainer = postEl.querySelector('.materials-container');
            materialsContainer.innerHTML = '';
            if (postData.materials.length === 0) {
                materialsContainer.innerHTML = `<p class="text-center text-slate-500 py-4">Belum ada materi. Klik tombol di bawah untuk menambahkan.</p>`;
            }
            let numberedCounter = 0;
            postData.materials.forEach((material) => {
                const materialRow = document.createElement('div');
                materialRow.className = `material-row group relative bg-slate-50 p-2 rounded-lg flex items-center gap-2 sm:gap-3 transition-all duration-300 anim-pop-in ${material.commanderExecutes ? 'font-bold' : ''}`;
                materialRow.dataset.materialId = material.id;
                
                let numberPrefix = '&nbsp;';
                if (material.isNumbered) {
                    numberedCounter++;
                    numberPrefix = `${numberedCounter}.`;
                } else {
                    numberPrefix = 'â€¢';
                }

                let contentHTML = '';
                switch(material.type) {
                    case 'report':
                        contentHTML = `<textarea class="report-input flex-grow bg-transparent p-1 rounded-md w-full focus:bg-white" placeholder="Ketik isi laporan...">${material.content || ''}</textarea>`;
                        break;
                    case 'start_end':
                         contentHTML = `<input type="text" value="${material.content || ''}" class="start-end-input flex-grow bg-transparent p-1 rounded-md w-full focus:bg-white font-semibold text-center text-slate-500" placeholder="MATERI MULAI / SELESAI">`;
                        break;
                    default:
                        const movementSpans = material.movements.map((mov, movIndex) => {
                            const command = PBB_COMMANDS.flatMap(c => c.items).find(i => i.id === mov.id);
                            if (!command) return '';
                            let chipHTML = command.needsInput 
                                ? `<input type="number" value="${mov.count || ''}" placeholder="..." data-movement-index="${movIndex}" class="movement-count-input w-10 text-center bg-transparent font-bold"> ${command.text}` 
                                : command.text;
                            return `<span class="movement-chip bg-white px-3 py-1 rounded-full shadow-sm flex items-center gap-2 text-sm">${chipHTML}</span>`;
                        }).join('<span class="font-bold text-slate-400 mx-1">â€“</span>');
                        
                        let movementContent = movementSpans;
                        if (movementSpans.length === 0) {
                            movementContent = `<button class="add-movement-btn text-rose-600 hover:underline">Tambah gerakan...</button>`;
                        } else {
                            movementContent += `<button class="add-movement-btn text-rose-600 p-1 rounded-full hover:bg-rose-100 ml-2" title="Tambah Gerakan Lagi"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg></button>`;
                        }
                        contentHTML = `<div class="movements-display flex-grow flex flex-wrap items-center gap-2">${movementContent}</div>`;
                }

                materialRow.innerHTML = `
                    <span class="font-bold text-slate-800 w-6 text-right">${numberPrefix}</span>
                    ${contentHTML}
                    <div class="contextual-controls flex items-center gap-2 sm:gap-3 ml-auto">
                        ${material.note ? `<span class="text-yellow-500 cursor-help" title="Catatan: ${material.note}">â˜…</span>` : ''}
                        <button class="settings-btn text-slate-500 hover:text-rose-600" title="Opsi Materi"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z" /></svg></button>
                        <button class="delete-material-btn text-slate-400 hover:text-red-500" title="Hapus Baris">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                `;
                materialsContainer.appendChild(materialRow);
            });
        };
        
        const openCommandModal = (materialId) => {
            currentTargetMaterialId = materialId;
            const modalEl = document.createElement('div');
            modalEl.id = 'command-modal';
            modalEl.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop';
            modalEl.innerHTML = `
                <div class="card w-full max-w-3xl max-h-[80vh] flex flex-col anim-pop-in">
                    <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="text-xl font-bold text-rose-800">Pilih Gerakan</h3>
                        <button class="modal-close-btn text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
                    </div>
                    <div class="p-4"><input type="text" id="modal-search" placeholder="Cari gerakan..." class="form-input w-full p-2 border rounded-lg"></div>
                    <div id="modal-command-list" class="p-4 pt-0 overflow-y-auto"></div>
                </div>`;
            modalContainer.appendChild(modalEl);
            renderCommandModal();
            document.getElementById('modal-search').focus();
            document.getElementById('modal-search').addEventListener('input', (e) => renderCommandModal(e.target.value));
        };

        const renderCommandModal = (filter = '') => {
            const modalCommandList = document.getElementById('modal-command-list');
            if (!modalCommandList) return;
            modalCommandList.innerHTML = '';
            const lowerCaseFilter = filter.toLowerCase();
            PBB_COMMANDS.forEach(category => {
                const filteredItems = category.items.filter(item => item.text.toLowerCase().includes(lowerCaseFilter));
                if (filteredItems.length === 0) return;

                const categoryWrapper = document.createElement('div');
                categoryWrapper.className = 'mb-4';
                categoryWrapper.innerHTML = `<h4 class="text-md font-semibold text-rose-700 mb-2 border-b border-slate-200 pb-1">${category.category}</h4>`;
                const itemsWrapper = document.createElement('div');
                itemsWrapper.className = 'grid grid-cols-1 md:grid-cols-2 gap-2';
                
                filteredItems.forEach(item => {
                    const card = document.createElement('button');
                    card.className = 'select-command-btn w-full text-left p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-rose-100 hover:border-rose-400 transition';
                    card.dataset.commandId = item.id;
                    card.textContent = item.text;
                    itemsWrapper.appendChild(card);
                });
                
                categoryWrapper.appendChild(itemsWrapper);
                modalCommandList.appendChild(categoryWrapper);
            });
        };

        const openContextMenu = (materialId) => {
            const material = plan.posts.flatMap(p => p.materials).find(m => m.id === materialId);
            if (!material) return;

            const modalEl = document.createElement('div');
            modalEl.id = 'context-menu-modal';
            modalEl.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop';
            modalEl.dataset.materialId = materialId;
            modalEl.innerHTML = `
                <div class="card w-full max-w-sm anim-pop-in">
                    <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="text-lg font-bold">Opsi Materi</h3>
                        <button class="modal-close-btn text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
                    </div>
                    <div class="p-4 space-y-4">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" class="context-danton-checkbox rounded text-rose-600 focus:ring-rose-500" ${material.commanderExecutes ? 'checked' : ''}>
                            <span>Dilaksanakan Danton</span>
                        </label>
                         <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" class="context-is-numbered-checkbox rounded text-rose-600 focus:ring-rose-500" ${material.isNumbered ? 'checked' : ''} ${material.type === 'adjustment' ? 'disabled' : ''}>
                            <span>Gunakan Penomoran</span>
                        </label>
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Catatan</label>
                            <input type="text" class="context-note-input mt-1 w-full p-2 border rounded-md form-input" value="${material.note || ''}" placeholder="misal: Waktu dimulai">
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 text-right rounded-b-xl">
                        <button class="modal-close-btn btn btn-primary py-2 px-4 rounded-lg">Tutup</button>
                    </div>
                </div>`;
            modalContainer.appendChild(modalEl);
        };
        
        const closeModal = () => {
            const modal = modalContainer.querySelector('.fixed');
            if (modal) {
                modal.remove();
            }
        };
        
        const generatePlanText = () => {
            let text = '';
            const planDetails = [
                plan.title ? plan.title.toUpperCase() : '',
                plan.description ? plan.description : '',
                plan.date ? `Tanggal: ${plan.date}` : '',
                plan.location ? `Lokasi: ${plan.location}` : ''
            ].filter(Boolean);

            if (planDetails.length > 0) {
                text += planDetails.join('\n') + '\n\n';
            }

            plan.posts.forEach((post, index) => {
                let postTitle = plan.posts.length > 1 ? `POS ${index + 1}` : (post.name || 'Pos Latihan');
                text += `--- ${postTitle} ---\n`;
                text += `Ukuran: ${post.size_p || '-'}m x ${post.size_l || '-'}m | Waktu: ${post.time || '-'} Menit\n\n`;
                
                let numberedCounter = 0;
                post.materials.forEach(material => {
                    let isNumbered = material.isNumbered;
                    if (isNumbered) numberedCounter++;

                    let line = '';
                    if (material.type === 'report') {
                        line = material.content || '(Laporan Kosong)';
                    } else if (material.type === 'start_end') {
                          line = material.content || '---';
                    } else {
                        const movementTexts = material.movements.map(mov => {
                            const command = PBB_COMMANDS.flatMap(c => c.items).find(i => i.id === mov.id);
                            if (!command) return null;
                            let commandText = command.text.replace('!', '');
                            if (command.needsInput && mov.count) {
                                commandText = `${mov.count} ${commandText}`;
                            }
                            return commandText;
                        }).filter(Boolean);
                        line = movementTexts.join(' â€“ ');
                    }

                    if (material.note) line += ` (${material.note})`;
                    if (material.commanderExecutes) line = `*${line}*`;

                    if (line) {
                        text += `${isNumbered ? `${numberedCounter}.` : 'â€¢'}\t${line}\n`;
                    }
                });
                text += '\n';
            });
            return text.trim();
        };

        const copyToClipboard = () => {
            if (copyTextBtn.disabled) {
                showToast('Lengkapi data pos dan materi terlebih dahulu.');
                return;
            }
            const textToCopy = generatePlanText();

            // Coba menggunakan API modern terlebih dahulu
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast('Rencana berhasil disalin!');
                    helperText.textContent = "Teks berhasil disalin ke clipboard!";
                    manualCopyArea.classList.add('hidden');
                }).catch(err => {
                    console.error('Clipboard API error:', err);
                    // Jika API modern gagal, gunakan fallback
                    fallbackCopyToClipboard(textToCopy);
                });
            } else {
                // Jika API modern tidak tersedia, langsung gunakan fallback
                fallbackCopyToClipboard(textToCopy);
            }
        };

        // Fallback menggunakan execCommand yang lebih kompatibel
        const fallbackCopyToClipboard = (textToCopy) => {
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            textArea.style.left = "-9999px";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('Rencana berhasil disalin!');
                    helperText.textContent = "Teks berhasil disalin ke clipboard!";
                    manualCopyArea.classList.add('hidden');
                } else {
                    throw new Error('Copy command was not successful');
                }
            } catch (err) {
                console.error('execCommand error:', err);
                // Jika semua cara gagal, tampilkan area copy manual
                helperText.innerHTML = `<strong>Gagal menyalin otomatis!</strong><br>Ini mungkin karena batasan keamanan browser. Silakan salin teks secara manual dari kotak di bawah ini (Ctrl+C).`;
                manualCopyTextarea.value = textToCopy;
                manualCopyArea.classList.remove('hidden');
                manualCopyTextarea.select();
            }

            document.body.removeChild(textArea);
        };


        const exportToPDF = () => {
            if (exportPdfBtn.disabled) {
                showToast('Lengkapi data pos dan materi terlebih dahulu.');
                return;
            }
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const printArea = document.getElementById('print-area');
            
            let content = `<h1>${plan.title || 'Rencana Latihan'}</h1>`;
            if (plan.description) content += `<p><i>${plan.description}</i></p>`;
            if (plan.date || plan.location) {
                 content += `<p><b>Tanggal:</b> ${plan.date || '-'} | <b>Lokasi:</b> ${plan.location || '-'}</p>`;
            }

            plan.posts.forEach((post, index) => {
                let postTitle = plan.posts.length > 1 ? `POS ${index + 1}` : (post.name || 'Pos Latihan');
                content += `<hr style="margin: 10px 0;"><h2>${postTitle}</h2>`;
                content += `<p><b>Ukuran:</b> ${post.size_p || '-'}m x ${post.size_l || '-'}m | <b>Alokasi Waktu:</b> ${post.time || '-'} Menit</p>`;
                
                let numberedCounter = 0;
                let listContent = '<div style="margin-left: 5mm;">';
                post.materials.forEach(material => {
                    let isNumbered = material.isNumbered;
                    if (isNumbered) numberedCounter++;

                    let line = '';
                     if (material.type === 'report') {
                        line = material.content || '(Laporan Kosong)';
                    } else if (material.type === 'start_end') {
                          line = `<i>${material.content || '---'}</i>`;
                    } else {
                        const movementTexts = material.movements.map(mov => {
                            const command = PBB_COMMANDS.flatMap(c => c.items).find(i => i.id === mov.id);
                            if (!command) return null;
                            let commandText = command.text.replace('!', '');
                            if (command.needsInput && mov.count) {
                                commandText = `${mov.count} ${commandText}`;
                            }
                            return commandText;
                        }).filter(Boolean);
                        line = movementTexts.join(' â€“ ');
                    }

                    if (material.note) line += ` (${material.note})`;
                    if (material.commanderExecutes) line = `<b>${line}</b>`;

                    if (line) {
                        listContent += `<p>${isNumbered ? `${numberedCounter}. ` : 'â€¢ '}${line}</p>`;
                    }
                });
                listContent += '</div>';
                content += listContent;
            });

            printArea.innerHTML = content;
            showToast('Membuat PDF...');
            
            html2canvas(printArea, { scale: 2, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                let heightLeft = pdfHeight;
                let position = 10;

                pdf.addImage(imgData, 'PNG', 10, position, pdfWidth, pdfHeight);
                heightLeft -= pdf.internal.pageSize.getHeight();

                while (heightLeft > 0) {
                    position = heightLeft - pdfHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 10, position, pdfWidth, pdfHeight);
                    heightLeft -= pdf.internal.pageSize.getHeight();
                }
                
                pdf.save(`${plan.title || 'rencana-latihan'}.pdf`);
            }).catch(err => {
                showToast('Gagal membuat PDF.');
                console.error("PDF Export error:", err);
            });
        };

        // --- EVENT HANDLERS ---
        document.addEventListener('input', (e) => {
            if (e.target.id === 'plan-title') plan.title = e.target.value;
            if (e.target.id === 'plan-description') plan.description = e.target.value;
            if (e.target.id === 'plan-date') plan.date = e.target.value;
            if (e.target.id === 'plan-location') plan.location = e.target.value;
            
            const postEl = e.target.closest('[data-post-id]');
            if (!postEl) return;
            const postId = postEl.dataset.postId;
            const post = plan.posts.find(p => p.id === postId);
            if (!post) return;

            const field = e.target.dataset.field;
            if (field) {
                post[field] = e.target.value;
                updateActionButtonsState();
            }

            const materialRow = e.target.closest('.material-row');
            if (materialRow) {
                const materialId = materialRow.dataset.materialId;
                const material = post.materials.find(m => m.id === materialId);
                if (!material) return;

                if (e.target.matches('.report-input, .start-end-input')) {
                    material.content = e.target.value;
                }
                if (e.target.matches('.movement-count-input')) {
                    const movementIndex = parseInt(e.target.dataset.movementIndex, 10);
                    if(material.movements[movementIndex]) {
                        material.movements[movementIndex].count = e.target.value;
                    }
                }
            }
            
            const contextMenu = document.querySelector('#context-menu-modal');
            if (contextMenu && e.target.matches('.context-note-input')) {
                const materialId = contextMenu.dataset.materialId;
                const material = plan.posts.flatMap(p => p.materials).find(m => m.id === materialId);
                if (material) {
                    material.note = e.target.value;
                }
            }
        });
        
        document.addEventListener('click', (e) => {
            if (e.target.closest('#add-post-btn')) {
                plan.posts.push({ id: `post_${Date.now()}`, name: '', time: '', size_p: '', size_l: '', materials: [] });
                renderPlan();
            }

            const deletePostBtn = e.target.closest('.delete-post-btn');
            if (deletePostBtn) {
                const postEl = deletePostBtn.closest('[data-post-id]');
                postEl.classList.add('anim-fade-out');
                postEl.addEventListener('animationend', () => {
                    plan.posts = plan.posts.filter(p => p.id !== postEl.dataset.postId);
                    renderPlan();
                });
            }

            const addMaterialOption = e.target.closest('.add-material-option');
            if(addMaterialOption) {
                const postId = addMaterialOption.closest('[data-post-id]').dataset.postId;
                const post = plan.posts.find(p => p.id === postId);
                if(post) {
                    const type = addMaterialOption.dataset.type;
                    const newMaterial = { id: `mat_${Date.now()}`, type: type, movements: [], commanderExecutes: false, note: '' };
                    newMaterial.isNumbered = type !== 'adjustment';
                    
                    if (type === 'start_end') {
                        const lastStartEnd = [...post.materials].reverse().find(m => m.type === 'start_end');
                        if (lastStartEnd && lastStartEnd.content.toUpperCase().includes('MULAI')) {
                            newMaterial.content = 'MATERI SELESAI';
                        } else {
                            newMaterial.content = 'MATERI MULAI';
                        }
                    } else if (type === 'report') {
                        newMaterial.content = '';
                    }

                    post.materials.push(newMaterial);
                    renderPlan();
                }
            }

            const deleteMaterialBtn = e.target.closest('.delete-material-btn');
            if (deleteMaterialBtn) {
                const materialRow = deleteMaterialBtn.closest('.material-row');
                materialRow.classList.add('anim-fade-out');
                materialRow.addEventListener('animationend', () => {
                    const postId = materialRow.closest('[data-post-id]').dataset.postId;
                    const post = plan.posts.find(p => p.id === postId);
                    if (post) {
                        post.materials = post.materials.filter(m => m.id !== materialRow.dataset.materialId);
                        renderPlan();
                    }
                });
            }

            const selectCommandBtn = e.target.closest('.select-command-btn');
            if (selectCommandBtn) {
                const commandId = selectCommandBtn.dataset.commandId;
                const post = plan.posts.find(p => p.materials.some(m => m.id === currentTargetMaterialId));
                if (!post) return;
                const material = post.materials.find(m => m.id === currentTargetMaterialId);
                if (!material) return;
                
                const command = PBB_COMMANDS.flatMap(c => c.items).find(i => i.id === commandId);
                const newMovement = { id: commandId };
                if (command.needsInput) newMovement.count = '';
                material.movements.push(newMovement);
                
                renderPlan();
                closeModal();
            }
            
            if(e.target.closest('.modal-close-btn') || e.target.matches('.modal-backdrop')) {
                if(e.target.closest('#context-menu-modal')) {
                    renderPlan();
                }
                closeModal();
            }
            
            if(e.target.closest('#export-pdf-btn')) exportToPDF();
            if(e.target.closest('#copy-text-btn')) copyToClipboard();

            const addMovementBtn = e.target.closest('.add-movement-btn');
            if (addMovementBtn) {
                const materialId = addMovementBtn.closest('.material-row').dataset.materialId;
                openCommandModal(materialId);
            }
            
            const settingsBtn = e.target.closest('.settings-btn');
            if(settingsBtn) {
                const materialId = settingsBtn.closest('.material-row').dataset.materialId;
                openContextMenu(materialId);
            }
        });
        
        document.addEventListener('change', (e) => {
              const contextMenu = document.querySelector('#context-menu-modal');
              if(!contextMenu) return;

              const materialId = contextMenu.dataset.materialId;
              const material = plan.posts.flatMap(p => p.materials).find(m => m.id === materialId);
              if(!material) return;

              if (e.target.matches('.context-danton-checkbox')) {
                material.commanderExecutes = e.target.checked;
              }
              if (e.target.matches('.context-is-numbered-checkbox')) {
                material.isNumbered = e.target.checked;
              }
        });

        // --- INITIALIZATION ---
        renderPlan();
    });
    </script>
</body>
</html>
