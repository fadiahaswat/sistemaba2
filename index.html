<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIAP! - Sistem Informasi Aba-aba Peleton</title>
    
    <!-- Pustaka Eksternal -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG0C+wFjr8bCqwA2ag==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Gaya Kustom -->
    <style>
        /* Variabel Warna Global & Tema Default (Maroon) */
        :root {
            --bg-primary: #0a0a0a;
            --bg-glass: rgba(23, 23, 23, 0.6); /* zinc-900 dengan opasitas */
            --border-glass: rgba(63, 63, 70, 0.3); /* zinc-700 dengan opasitas */
            --text-primary: #f4f4f5; /* zinc-100 */
            --text-secondary: #a1a1aa; /* zinc-400 */
            
            /* Tema Default (Beranda - Maroon) */
            --theme-color-hex: #9f1239; /* rose-800 */
            --theme-color-focus: #e11d48; /* rose-600 */
            --theme-color-aurora: rgba(159, 18, 57, 0.2);
        }
        
        /* Definisi Tema per Halaman */
        .theme-beranda, .theme-beranda-cta {
            --theme-color-hex: #9f1239;
            --theme-color-focus: #e11d48;
            --theme-color-aurora: rgba(159, 18, 57, 0.2);
        }
        .theme-editor, .theme-editor-cta {
            --theme-color-hex: #f97316; /* orange-500 */
            --theme-color-focus: #fb923c; /* orange-400 */
            --theme-color-aurora: rgba(249, 115, 22, 0.15);
        }
        .theme-riwayat, .theme-riwayat-cta {
            --theme-color-hex: #1d4ed8; /* blue-700 */
            --theme-color-focus: #3b82f6; /* blue-500 */
            --theme-color-aurora: rgba(29, 78, 216, 0.15);
        }
        .theme-tempo, .theme-tempo-cta {
            --theme-color-hex: #7c3aed; /* violet-600 */
            --theme-color-focus: #8b5cf6; /* violet-500 */
            --theme-color-aurora: rgba(124, 58, 237, 0.15);
        }
        .theme-visualisasi, .theme-visualisasi-cta {
            --theme-color-hex: #059669; /* emerald-600 */
            --theme-color-focus: #10b981; /* emerald-500 */
            --theme-color-aurora: rgba(5, 150, 105, 0.15);
        }

        /* Gaya Dasar */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }
        
        /* Komponen UI Kustom */
        .glass-card {
            background-color: var(--bg-glass);
            border: 1px solid var(--border-glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.3s ease;
        }
        .glass-card:hover {
            background-color: rgba(39, 39, 42, 0.7);
            border-color: rgba(82, 82, 91, 0.5);
        }
        .riwayat-card:hover {
            transform: translateY(-4px);
        }

        .form-input {
            background-color: rgba(63, 63, 70, 0.5);
            border-color: var(--border-glass);
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .form-input:focus {
            --tw-ring-color: var(--theme-color-focus);
            background-color: rgba(38, 38, 38, 0.8);
            border-color: var(--theme-color-focus);
        }
        input[type="date"] { color-scheme: dark; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); }

        .btn { transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn:hover:not(:disabled) { transform: translateY(-2px) scale(1.05); filter: brightness(1.15); }
        .btn:active:not(:disabled) { transform: translateY(0) scale(1); }
        .btn-primary {
            background-color: var(--theme-color-hex);
            color: white;
            box-shadow: 0 4px 20px -5px var(--theme-color-hex);
        }
        .btn:disabled {
            background-color: #3f3f46;
            color: #a1a1aa;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            filter: none;
            opacity: 0.5;
        }
        
        .modal-backdrop {
            background-color: rgba(9, 9, 11, 0.5);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
        }

        /* Gaya Drag & Drop */
        .material-row.dragging {
            opacity: 0.5;
            background: var(--theme-color-aurora);
        }
        .material-row.drag-over {
            border-top: 2px solid var(--theme-color-focus);
        }


        /* Animasi */
        .anim-fade-in { animation: fadeIn 0.5s cubic-bezier(0.215, 0.610, 0.355, 1.000) forwards; }
        .anim-fade-out { animation: fadeOut 0.3s cubic-bezier(0.550, 0.055, 0.675, 0.190) forwards; }
        .anim-pop-in { animation: popIn 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .list-item-exit-active { opacity: 0; transform: scale(0.95); transition: all 0.3s ease; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Animasi Latar Belakang Aurora */
        .aurora-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: -1;
        }
        .aurora-background::before {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 200vw; height: 200vh;
            background: radial-gradient(circle, var(--theme-color-aurora), transparent 60%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulse 10s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            transition: background 0.5s ease-in-out;
        }
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.7; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
        }
        
        /* Animasi Ikon */
        @keyframes icon-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .icon-pulse { animation: icon-pulse 2s infinite ease-in-out; }

        /* Utilitas Tema */
        .text-theme { color: var(--theme-color-focus); }
        .bg-theme-20 { background-color: color-mix(in srgb, var(--theme-color-hex) 20%, transparent); }
        .text-theme-focus { color: var(--theme-color-focus); }
        .border-theme-focus { border-color: var(--theme-color-focus) !important; }
        .gradient-theme { background-image: linear-gradient(to right, var(--theme-color-focus), var(--theme-color-hex)); }

        .page-content { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="antialiased">
    
    <div id="app-container">
        <!-- Latar Belakang Animasi Aurora -->
        <div id="aurora-container" class="aurora-background"></div>

        <div class="min-h-screen flex flex-col relative z-10 pb-20 md:pb-0">
            <!-- Header (Desktop & Mobile) -->
            <header class="bg-zinc-900/70 backdrop-blur-lg border-b border-zinc-800/50 sticky top-0 z-30">
                <div class="container mx-auto px-4 md:px-8 flex items-center justify-between h-16">
                    <!-- Sisi Kiri: Judul Halaman (Mobile) / Logo (Desktop) -->
                    <div class="flex items-center gap-3">
                        <a href="#" data-page="beranda" class="nav-btn hidden md:flex items-center gap-3">
                            <div id="header-logo-bg-desktop" class="w-10 h-10 rounded-lg text-white flex items-center justify-center text-2xl shadow-md transition-colors duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#FFFFFF"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            </div>
                            <h1 class="text-xl font-bold text-gray-200">SIAP!</h1>
                        </a>
                        <h2 id="mobile-header-title" class="text-lg font-bold text-gray-200 md:hidden">Beranda</h2>
                    </div>

                    <!-- Sisi Kanan: Logo (Mobile) / Navigasi (Desktop) -->
                    <div class="flex items-center">
                        <nav class="hidden md:flex items-center gap-2 sm:gap-4 text-sm font-semibold">
                            <button data-page="beranda" class="nav-btn px-3 py-2 rounded-lg transition-colors">Beranda</button>
                            <button data-page="editor" class="nav-btn px-3 py-2 rounded-lg transition-colors">Editor</button>
                            <button data-page="riwayat" class="nav-btn px-3 py-2 rounded-lg transition-colors">Riwayat</button>
                            <button data-page="tempo" class="nav-btn px-3 py-2 rounded-lg transition-colors">Tempo</button>
                            <button data-page="visualisasi" class="nav-btn px-3 py-2 rounded-lg transition-colors">Baca Perpang</button>
                        </nav>
                        <a href="#" data-page="beranda" class="nav-btn flex items-center gap-3 md:hidden">
                            <h1 class="text-lg font-bold text-gray-200">SIAP!</h1>
                            <div id="header-logo-bg-mobile" class="w-10 h-10 rounded-lg text-white flex items-center justify-center text-2xl shadow-md transition-colors duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#FFFFFF"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            </div>
                        </a>
                    </div>
                </div>
            </header>

            <!-- Konten Utama -->
            <main class="container mx-auto p-4 md:px-8 flex-grow">
                <div id="page-container">
                    <!-- Halaman: Beranda -->
                    <div id="page-beranda" class="page-content">
                        <section id="hero" class="text-center py-12 md:py-20 anim-fade-in">
                            <div class="w-20 h-20 mx-auto rounded-2xl text-white flex items-center justify-center text-5xl shadow-md mb-6" style="background-color: #9f1239;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            </div>
                            <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight text-transparent bg-clip-text gradient-theme">
                                Presisi dalam Setiap Rencana
                            </h1>
                            <p class="mt-4 max-w-2xl mx-auto text-lg text-zinc-400">
                                Alat bantu modern untuk merancang, menyimpan, dan membagikan skenario aba-aba baris-berbaris dengan detail dan akurasi tinggi.
                            </p>
                            <div class="mt-12 grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                                <button data-page="editor" class="nav-btn glass-card p-6 rounded-xl text-left hover:-translate-y-2 theme-editor-cta relative overflow-hidden">
                                    <div class="absolute -bottom-8 -right-8 text-white/5 z-0">
                                        <svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04C21.1 6.65 21.1 6.02 20.71 5.63L18.37 3.29C17.98 2.9 17.35 2.9 16.96 3.29L15.13 5.12L18.88 8.87M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25Z" /></svg>
                                    </div>
                                    <div class="relative z-10 flex items-center gap-4">
                                        <div class="w-12 h-12 bg-theme-20 text-theme-focus rounded-lg flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-bold text-zinc-100">Buka Editor</h3>
                                            <p class="text-sm text-zinc-400">Mulai merancang atau mengedit.</p>
                                        </div>
                                    </div>
                                </button>
                                <button data-page="visualisasi" class="nav-btn glass-card p-6 rounded-xl text-left hover:-translate-y-2 theme-visualisasi-cta relative overflow-hidden">
                                    <div class="absolute -bottom-8 -right-8 text-white/5 z-0">
                                        <svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M20 5V19C20 20.11 19.11 21 18 21V3C19.11 3 20 3.9 20 5M16 3V21H4C2.9 21 2 20.11 2 19V5C2 3.9 2.9 3 4 3H16M14 12V10H6V12H14M14 15V13H6V15H14M10 9V7H6V9H10Z" /></svg>
                                    </div>
                                    <div class="relative z-10 flex items-center gap-4">
                                        <div class="w-12 h-12 bg-theme-20 text-theme-focus rounded-lg flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-bold text-zinc-100">Baca Perpang</h3>
                                            <p class="text-sm text-zinc-400">Buka dokumen PBB resmi.</p>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </section>
                        <section id="recent-history" class="py-12">
                            <h2 class="text-2xl font-bold text-center mb-8">Riwayat Terakhir</h2>
                            <div id="recent-riwayat-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
                                <!-- Riwayat terakhir akan dirender di sini -->
                            </div>
                            <div id="view-all-history-container" class="text-center mt-10 hidden">
                                <button data-page="riwayat" class="nav-btn btn btn-primary px-6 py-2 rounded-lg">Lihat Semua Riwayat</button>
                            </div>
                        </section>
                    </div>

                    <!-- Halaman: Editor -->
                    <div id="page-editor" class="page-content hidden">
                        <div class="text-center py-8 anim-fade-in">
                            <h1 class="text-3xl md:text-4xl font-bold text-theme flex items-center justify-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                Editor Rencana
                            </h1>
                             <p class="mt-2 text-zinc-400 max-w-xl mx-auto">Rancang skenario aba-aba Anda secara detail di sini, pos demi pos.</p>
                        </div>
                        <div id="app-editor" class="grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            <aside class="lg:col-span-1 xl:col-span-1 space-y-6">
                                <div class="glass-card p-5 rounded-xl">
                                    <h2 class="text-lg font-bold mb-4 text-theme">Detail Informasi</h2>
                                    <div class="space-y-3">
                                        <input type="text" id="plan-title" placeholder="Nama Aba-aba (Wajib)" class="form-input w-full p-2 border rounded-lg text-sm" title="Masukkan nama atau judul untuk rencana aba-aba ini.">
                                        <textarea id="plan-description" placeholder="Deskripsi singkat" class="form-input w-full p-2 border rounded-lg text-sm" rows="2" title="Tambahkan deskripsi singkat mengenai tujuan atau konteks dari rencana ini."></textarea>
                                        <input type="date" id="plan-date" class="form-input w-full p-2 border rounded-lg text-zinc-400 text-sm" title="Pilih tanggal pelaksanaan.">
                                        <input type="text" id="plan-location" placeholder="Lokasi" class="form-input w-full p-2 border rounded-lg text-sm" title="Tentukan lokasi tempat latihan atau acara.">
                                    </div>
                                </div>
                                <div class="glass-card p-5 rounded-xl">
                                    <div class="flex justify-between items-center mb-4">
                                        <h2 class="text-lg font-bold text-theme">Daftar Pos</h2>
                                        <button id="add-post-btn" class="btn btn-primary text-sm font-semibold py-1 px-3 flex items-center gap-1 rounded-lg">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                            Pos
                                        </button>
                                    </div>
                                    <div id="posts-nav-list" class="space-y-2"></div>
                                </div>
                            </aside>
                            <section id="workspace" class="lg:col-span-2 xl:col-span-3"></section>
                        </div>
                    </div>

                    <!-- Halaman: Riwayat -->
                    <div id="page-riwayat" class="page-content hidden">
                        <div class="text-center py-8 anim-fade-in">
                            <h1 class="text-3xl md:text-4xl font-bold text-theme flex items-center justify-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                Riwayat Aba-aba
                            </h1>
                            <p class="mt-4 text-zinc-400">Daftar rencana yang telah Anda simpan akan muncul di sini.</p>
                            <div id="riwayat-list" class="mt-8 max-w-3xl mx-auto space-y-4">
                               <!-- Item riwayat akan dirender di sini oleh JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Halaman: Tempo -->
                    <div id="page-tempo" class="page-content hidden">
                        <div class="text-center py-8 anim-fade-in">
                            <h1 class="text-3xl md:text-4xl font-bold text-theme flex items-center justify-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l10-3v10l-10 3zM9 6H5v11h4" /></svg>
                                Tempo Gerakan
                            </h1>
                            <p id="metronome-status" class="mt-4 text-zinc-400 max-w-2xl mx-auto h-6">Metronom berhenti. Pilih salah satu tempo untuk memulai.</p>
                        </div>
                        <main id="tempo-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 max-w-7xl mx-auto">
                            <!-- Kartu tempo akan dimasukkan di sini oleh JavaScript -->
                        </main>
                    </div>

                    <!-- Halaman: Visualisasi (Baca Perpang) -->
                    <div id="page-visualisasi" class="page-content hidden">
                         <div class="text-center py-8 anim-fade-in">
                            <h1 class="text-3xl md:text-4xl font-bold text-theme flex flex-col sm:flex-row items-center justify-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                                <span>Baca Dokumen Perpang</span>
                            </h1>
                            <p class="mt-4 text-zinc-400 max-w-2xl mx-auto">Pilih dokumen Peraturan Panglima TNI untuk dibaca. Dokumen akan ditampilkan dalam format PDF.</p>
                            <div id="perpang-cards-container" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                                <!-- Card 1: PERPANG 57 -->
                                 <div class="glass-card rounded-xl p-6 text-left flex flex-col overflow-hidden relative theme-riwayat-cta hover:-translate-y-2">
                                     <div class="absolute -bottom-8 -right-8 text-white/5 z-0">
                                         <svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 12.25C13.24 12.25 14.25 11.24 14.25 10C14.25 8.76 13.24 7.75 12 7.75C10.76 7.75 9.75 8.76 9.75 10C9.75 11.24 10.76 12.25 12 12.25M12 14.25C9.33 14.25 4.5 15.58 4.5 18.25V20H19.5V18.25C19.5 15.58 14.67 14.25 12 14.25M12 4C16.42 4 20 7.58 20 12C20 16.42 16.42 20 12 20C7.58 20 4 16.42 4 12C4 7.58 7.58 4 12 4Z" /></svg>
                                     </div>
                                     <div class="relative z-10">
                                         <h3 class="text-lg font-bold text-zinc-100">Perpang TNI No. 57 Th 2018</h3>
                                         <p class="text-sm text-zinc-400 mt-2 flex-grow">Tentang Peraturan Penghormatan Militer (PPM) Tentara Nasional Indonesia.</p>
                                         <button class="open-pdf-btn btn btn-primary mt-4 self-start rounded-lg px-4 py-2 text-sm" data-pdf-url="https://drive.google.com/file/d/1sTDe64-dQCAw25INF5kfbMt6GtlMNyrc/view?usp=sharing" data-pdf-title="Perpang TNI No. 57 Th 2018 - PPM">
                                             Baca Dokumen
                                         </button>
                                     </div>
                                 </div>
                                <!-- Card 2: PERPANG 58 -->
                                <div class="glass-card rounded-xl p-6 text-left flex flex-col overflow-hidden relative theme-visualisasi-cta hover:-translate-y-2">
                                     <div class="absolute -bottom-8 -right-8 text-white/5 z-0">
                                         <svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M3 13H11V11H3M3 18H11V16H3M3 8H11V6H3M13 18V16H21V18M13 13H21V11H13M13 8V6H21V8Z" /></svg>
                                     </div>
                                     <div class="relative z-10">
                                         <h3 class="text-lg font-bold text-zinc-100">Perpang TNI No. 58 Th 2018</h3>
                                         <p class="text-sm text-zinc-400 mt-2 flex-grow">Tentang Peraturan Baris Berbaris (PBB) Tentara Nasional Indonesia.</p>
                                         <button class="open-pdf-btn btn btn-primary mt-4 self-start rounded-lg px-4 py-2 text-sm" data-pdf-url="https://drive.google.com/file/d/13_lH4YlqfXQJobfTm8TBsTSa7Rp5RXYD/view?usp=sharing" data-pdf-title="Perpang TNI No. 58 Th 2018 - PBB">
                                             Baca Dokumen
                                         </button>
                                     </div>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Asisten SIAP (Hanya tampil di halaman editor) -->
                <div id="helper-box" class="glass-card p-6 rounded-2xl mt-8" style="display: none;">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-center">
                        <div class="lg:col-span-5 flex items-center gap-4">
                            <div class="flex-shrink-0 w-16 h-16 bg-theme-20 text-theme-focus rounded-full flex items-center justify-center icon-pulse">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                            </div>
                            <div class="flex-grow">
                                 <p class="font-bold text-lg text-zinc-100">Asisten SIAP!</p>
                                 <p id="helper-text" class="text-sm text-zinc-400 transition-all duration-300">Selamat datang!</p>
                            </div>
                        </div>
                        <div class="lg:col-span-7">
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                <!-- Aksi Utama -->
                                <button id="save-plan-btn" class="btn btn-primary text-sm flex flex-col items-center justify-center gap-1 p-2 rounded-lg h-16 col-span-2" title="Simpan Rencana"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg><span>Simpan</span></button>
                                <!-- Aksi Pembuatan -->
                                <button id="new-plan-btn" class="btn bg-zinc-700/80 text-sm flex flex-col items-center justify-center gap-1 p-2 rounded-lg h-16" title="Rencana Baru"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span>Baru</span></button>
                                <button id="duplicate-plan-btn" class="btn bg-zinc-700/80 text-sm flex flex-col items-center justify-center gap-1 p-2 rounded-lg h-16" title="Duplikat"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16a2 2 0 002 2h8a2 2 0 002-2V8a2 2 0 00-2-2h-3l-4-4-4 4H8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><span>Duplikat</span></button>
                                <!-- Aksi Ekspor/Bagikan -->
                                <button id="copy-text-btn" class="btn bg-zinc-800/80 text-sm flex flex-col items-center justify-center gap-1 p-2 rounded-lg h-16" title="Salin Teks"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><span>Salin</span></button>
                                <button id="export-pdf-btn" class="btn bg-zinc-800/80 text-sm flex flex-col items-center justify-center gap-1 p-2 rounded-lg h-16" title="Ekspor PDF"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg><span>PDF</span></button>
                                <button id="share-btn" class="btn bg-zinc-800/80 text-sm flex flex-col items-center justify-center gap-1 p-2 rounded-lg h-16" title="Bagikan"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg><span>Bagikan</span></button>
                                <!-- Aksi Hapus -->
                                <button id="delete-plan-btn" class="btn bg-red-900/60 text-red-300 hover:bg-red-800/80 hover:text-red-100 text-sm flex flex-col items-center justify-center gap-1 p-2 rounded-lg h-16" title="Hapus"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg><span>Hapus</span></button>
                            </div>
                            <!-- Area Salin Manual (jika navigator.clipboard gagal) -->
                            <div id="manual-copy-area" class="mt-4 hidden">
                                <textarea id="manual-copy-textarea" class="form-input w-full p-2 border rounded-lg text-sm bg-zinc-800 text-zinc-200" rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
            
            <!-- Footer -->
            <footer class="bg-zinc-900/80 border-t border-zinc-800/50 mt-auto p-4 text-sm text-zinc-500">
                <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center gap-4 text-center sm:text-left">
                    <p>&copy; 2025 SIAP! - Dikembangkan oleh 1nspektur Tonti Mu'allimin.</p>
                     <div class="flex items-center gap-3">
                         <a href="https://wa.me/6285339213109" target="_blank" class="glass-card p-2.5 rounded-lg flex items-center justify-center" title="Hubungi via WhatsApp" aria-label="Hubungi via WhatsApp">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="text-green-500" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.89 7.89 0 0 0 13.6 2.326zM7.994 14.521a6.57 6.57 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943c-.049-.084-.182-.133-.38-.232z"/></svg>
                         </a>
                         <a href="https://www.instagram.com/tontimuallimin/" target="_blank" class="glass-card p-2.5 rounded-lg flex items-center justify-center" title="Kunjungi Instagram" aria-label="Kunjungi Instagram">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="text-rose-500" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.9 3.9 0 0 0-1.417.923A3.9 3.9 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.703.01 5.556 0 5.829 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.556 15.99 5.829 16 8 16s2.444-.01 3.297-.048c.852-.04 1.433-.174 1.942-.372.526-.205.972-.478 1.417-.923.445-.444.718-.891.923-1.417.198-.509.333-1.09.372-1.942C15.99 10.444 16 10.173 16 8s-.01-2.444-.048-3.297c-.04-.852-.174-1.433-.372-1.942a3.9 3.9 0 0 0-.923-1.417A3.9 3.9 0 0 0 13.24.42c-.51-.198-1.09-.333-1.942-.372C10.444.01 10.173 0 8 0zm0 1.442c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599s.453.546.598.92c.11.281.24.705.275 1.485.039.843.047 1.096.047 3.233s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.5 2.5 0 0 1-.599.92 2.5 2.5 0 0 1-.92.598c-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.5 2.5 0 0 1-.92-.598 2.5 2.5 0 0 1-.598-.92c-.11-.282-.24-.705-.276-1.486-.038-.843-.046-1.096-.046-3.232s.008-2.389.046-3.233c.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92s.546-.453.92-.598c.282-.11.705-.24 1.485-.276.843-.038 1.096-.047 3.232-.047zM8 3.882a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 6.774a2.667 2.667 0 1 1 0-5.334 2.667 2.667 0 0 1 0 5.334zM12.974 3.882a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92z"/></svg>
                         </a>
                         <a href="https://www.tiktok.com/@tontimuallimin" target="_blank" class="glass-card p-2.5 rounded-lg flex items-center justify-center" title="Kunjungi TikTok" aria-label="Kunjungi TikTok">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="text-white" fill="currentColor" viewBox="0 0 16 16">
                               <path d="M9 0h1.98c.144.715.54 1.617 1.235 2.512C12.895 3.389 13.797 4 15 4v2c-1.753 0-3.07-.814-4-1.829V11a5 5 0 1 1-5-5v2a3 3 0 1 0 3 3V0Z"/>
                            </svg>
                         </a>
                     </div>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- Navigasi Bawah (Mobile) -->
    <nav id="bottom-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-zinc-900/80 backdrop-blur-lg border-t border-zinc-800/50 z-40 transition-colors duration-300">
        <div class="flex justify-around items-center h-16">
            <button data-page="beranda" class="bottom-nav-btn flex flex-col items-center justify-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                <span class="text-xs mt-1">Beranda</span>
            </button>
            <button data-page="editor" class="bottom-nav-btn flex flex-col items-center justify-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span class="text-xs mt-1">Editor</span>
            </button>
            <button data-page="riwayat" class="bottom-nav-btn flex flex-col items-center justify-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span class="text-xs mt-1">Riwayat</span>
            </button>
            <button data-page="tempo" class="bottom-nav-btn flex flex-col items-center justify-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l10-3v10l-10 3zM9 6H5v11h4" /></svg>
                <span class="text-xs mt-1">Tempo</span>
            </button>
            <button data-page="visualisasi" class="bottom-nav-btn flex flex-col items-center justify-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                <span class="text-xs mt-1">Perpang</span>
            </button>
        </div>
    </nav>

    <!-- Kontainer untuk Modal & Area Cetak -->
    <div id="modal-container"></div>
    <div id="print-area" class="hidden" style="font-family: 'Inter', sans-serif; color: black; background: white; padding: 20px;"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const SiapApp = {
            //======================================================================
            // DATA & STATE
            //======================================================================
            PBB_COMMANDS: [
                { category: 'Gerakan Tambahan', items: [ 
                    { id: 'custom_honor_jury', text: 'Kepada Dewan Juri, Hormat = GERAK!' },
                    { id: 'custom_report_start', text: 'LAPOR! (...)', isCustomText: true }, 
                    { id: 'custom_report_end', text: '(...) LAPORAN SELESAI!', isCustomText: true }, 
                    { id: 'custom_start', text: 'MATERI MULAI!' }, 
                    { id: 'custom_end', text: 'MATERI SELESAI!' } 
                ]},
                { category: 'Sikap Sempurna & Istirahat', items: [ { id: 'siap_gerak', text: 'Siap = GERAK!' }, { id: 'parade_siap_gerak', text: 'Parade, Siap = GERAK!' }, { id: 'duduk_siap_gerak', text: 'Duduk Siap = GERAK!' }, { id: 'istirahat_ditempat_gerak', text: 'Istirahat di Tempat = GERAK!' }, { id: 'parade_istirahat_ditempat_gerak', text: 'Parade, Istirahat di Tempat = GERAK!' }, { id: 'untuk_perhatian', text: 'Untuk Perhatian!' } ] },
                { category: 'Lencang & Tegak', items: [ { id: 'lencang_kanan_gerak', text: 'Lencang Kanan = GERAK!' }, { id: 'lencang_kiri_gerak', text: 'Lencang Kiri = GERAK!' }, { id: 'setengah_lengan_lencang_kanan_gerak', text: 'Setengah Lengan Lencang Kanan = GERAK!' }, { id: 'setengah_lengan_lencang_kiri_gerak', text: 'Setengah Lengan Lencang Kiri = GERAK!' }, { id: 'lencang_depan_gerak', text: 'Lencang Depan = GERAK!' }, { id: 'tegak_gerak', text: 'Tegak = GERAK!' } ] },
                { category: 'Penghormatan', items: [ { id: 'hormat_gerak', text: 'Hormat = GERAK!' }, { id: 'hormat_kanan_gerak', text: 'Hormat Kanan = GERAK!' }, { id: 'hormat_kiri_gerak', text: 'Hormat Kiri = GERAK!' } ] },
                { category: 'Berhitung', items: [ { id: 'hitung_mulai', text: 'Hitung = MULAI!' } ] },
                { category: 'Periksa Kerapihan', items: [ { id: 'periksa_kerapian_mulai', text: 'Periksa Kerapian = MULAI!' }, { id: 'periksa_kerapian_selesai', text: 'SELESAI!' }, { id: 'parade_periksa_kerapian_mulai', text: 'Parade, Periksa Kerapian = MULAI!' } ] },
                { category: 'Buka & Tutup Barisan', items: [ { id: 'buka_barisan_jalan', text: 'Buka Barisan = JALAN!' }, { id: 'tutup_barisan_jalan', text: 'Tutup Barisan = JALAN!' } ] },
                { category: 'Perubahan Arah (Di Tempat)', items: [ { id: 'hadap_kanan_gerak', text: 'Hadap Kanan = GERAK!' }, { id: 'hadap_kiri_gerak', text: 'Hadap Kiri = GERAK!' }, { id: 'hadap_serong_kanan_gerak', text: 'Hadap Serong Kanan = GERAK!' }, { id: 'hadap_serong_kiri_gerak', text: 'Hadap Serong Kiri = GERAK!' }, { id: 'balik_kanan_gerak', text: 'Balik Kanan = GERAK!' } ] },
                { category: 'Bubar', items: [ { id: 'bubar_jalan', text: 'Bubar = JALAN!' } ] },
                { category: 'Jalan di Tempat', items: [ { id: 'jalan_ditempat_gerak', text: 'Jalan di Tempat = GERAK!' }, { id: 'henti_gerak_ditempat', text: 'Henti = GERAK!' } ] },
                { category: 'Perubahan Arah (Jalan di Tempat)', items: [
                    { id: 'hadap_kanan_jdt_gerak', text: 'Hadap Kanan, Jalan di Tempat = GERAK!' },
                    { id: 'hadap_kiri_jdt_gerak', text: 'Hadap Kiri, Jalan di Tempat = GERAK!' },
                    { id: 'hadap_serong_kanan_jdt_gerak', text: 'Hadap Serong Kanan, Jalan di Tempat = GERAK!' },
                    { id: 'hadap_serong_kiri_jdt_gerak', text: 'Hadap Serong Kiri, Jalan di Tempat = GERAK!' },
                    { id: 'balik_kanan_jdt_gerak', text: 'Balik Kanan, Jalan di Tempat = GERAK!' },
                ]},
                { category: 'Gerakan Berjalan (Berhenti ke Berjalan)', items: [ { id: 'maju_jalan', text: 'Maju = JALAN!' }, { id: 'langkah_tegap_maju_jalan', text: 'Langkah Tegap Maju = JALAN!' }, { id: 'langkah_perlahan_maju_jalan', text: 'Langkah Perlahan Maju = JALAN!' }, { id: 'langkah_ke_kanan_jalan', text: 'Langkah ke Kanan = JALAN!', needsInput: true, max: 4 }, { id: 'langkah_ke_kiri_jalan', text: 'Langkah ke Kiri = JALAN!', needsInput: true, max: 4 }, { id: 'langkah_ke_belakang_jalan', text: 'Langkah ke Belakang = JALAN!', needsInput: true, max: 4 }, { id: 'langkah_ke_depan_jalan', text: 'Langkah ke Depan = JALAN!', needsInput: true, max: 4 }, { id: 'henti_gerak_berjalan', text: 'Henti = GERAK!' } ]},
                { category: 'Gerakan Berlari (Berhenti ke Berlari & Berjalan ke Berlari)', items: [ { id: 'lari_maju_jalan', text: 'Lari Maju = JALAN!' }, { id: 'lari_jalan', text: 'Lari = JALAN!' }, { id: 'henti_gerak_berlari', text: 'Henti = GERAK!' } ]},
                { category: 'Gerakan Transisi (Berjalan & Berlari)', items: [ { id: 'langkah_tegap_jalan', text: 'Langkah Tegap = JALAN!' }, { id: 'langkah_biasa_jalan', text: 'Langkah Biasa = JALAN!' }, { id: 'langkah_perlahan_jalan', text: 'Langkah Perlahan = JALAN!' }, { id: 'langkah_merdeka_jalan', text: 'Langkah Merdeka = JALAN!' }, { id: 'ganti_langkah_jalan', text: 'Ganti Langkah = JALAN!' } ]},
                { category: 'Perubahan Arah (Berjalan)', items: [ { id: 'hadap_kanan_maju_jalan', text: 'Hadap Kanan Maju = JALAN!' }, { id: 'hadap_kiri_maju_jalan', text: 'Hadap Kiri Maju = JALAN!' }, { id: 'hadap_serong_kanan_maju_jalan', text: 'Hadap Serong Kanan Maju = JALAN!' }, { id: 'hadap_serong_kiri_maju_jalan', text: 'Hadap Serong Kiri Maju = JALAN!' }, { id: 'balik_kanan_maju_jalan', text: 'Balik Kanan Maju = JALAN!' }, { id: 'belok_kanan_jalan', text: 'Belok Kanan = JALAN!' }, { id: 'belok_kiri_jalan', text: 'Belok Kiri = JALAN!' }, { id: 'dua_kali_belok_kanan_jalan', text: 'Dua Kali Belok Kanan = JALAN!' }, { id: 'dua_kali_belok_kiri_jalan', text: 'Dua Kali Belok Kiri = JALAN!' }, { id: 'tiap_tiap_banjar_2x_belok_kanan_jalan', text: 'Tiap-tiap Banjar Dua Kali Belok Kanan = JALAN!' }, { id: 'tiap_tiap_banjar_2x_belok_kiri_jalan', text: 'Tiap-tiap Banjar Dua Kali Belok Kiri = JALAN!' } ]},
                { category: 'Perubahan Arah (Berjalan ke Berhenti)', items: [ { id: 'hadap_kanan_henti_gerak', text: 'Hadap Kanan Henti = GERAK!' }, { id: 'hadap_kiri_henti_gerak', text: 'Hadap Kiri Henti = GERAK!' }, { id: 'hadap_serong_kanan_henti_gerak', text: 'Hadap Serong Kanan Henti = GERAK!' }, { id: 'hadap_serong_kiri_henti_gerak', text: 'Hadap Serong Kiri Henti = GERAK!' }, { id: 'balik_kanan_henti_gerak', text: 'Balik Kanan Henti = GERAK!' } ]},
                { category: 'Perubahan Arah (Berlari)', items: [ { id: 'hadap_kanan_lari_maju_jalan', text: 'Hadap Kanan Lari Maju = JALAN!' }, { id: 'hadap_kiri_lari_maju_jalan', text: 'Hadap Kiri Lari Maju = JALAN!' }, { id: 'hadap_serong_kanan_lari_maju_jalan', text: 'Hadap Serong Kanan Lari Maju = JALAN!' }, { id: 'hadap_serong_kiri_lari_maju_jalan', text: 'Hadap Serong Kiri Lari Maju = JALAN!' }, { id: 'balik_kanan_lari_maju_jalan', text: 'Balik Kanan Lari Maju = JALAN!' } ]},
                { category: 'Perubahan Arah (Berlari ke Berhenti)', items: [ { id: 'hadap_kanan_lari_henti_gerak', text: 'Hadap Kanan Henti = GERAK!' }, { id: 'hadap_kiri_lari_henti_gerak', text: 'Hadap Kiri Henti = GERAK!' }, { id: 'hadap_serong_kanan_lari_henti_gerak', text: 'Hadap Serong Kanan Henti = GERAK!' }, { id: 'hadap_serong_kiri_lari_henti_gerak', text: 'Hadap Serong Kiri Henti = GERAK!' }, { id: 'balik_kanan_lari_henti_gerak', text: 'Balik Kanan Henti = GERAK!' } ]},
                { category: 'Haluan & Melintang', items: [ { id: 'haluan_kanan_jalan', text: 'Haluan Kanan = JALAN!' }, { id: 'haluan_kiri_jalan', text: 'Haluan Kiri = JALAN!' }, { id: 'haluan_kanan_maju_jalan', text: 'Haluan Kanan Maju = JALAN!' }, { id: 'haluan_kiri_maju_jalan', text: 'Haluan Kiri Maju = JALAN!' }, { id: 'melintang_kanan_jalan', text: 'Melintang Kanan = JALAN!' }, { id: 'melintang_kiri_jalan', text: 'Melintang Kiri = JALAN!' }, { id: 'melintang_kanan_maju_jalan', text: 'Melintang Kanan Maju = JALAN!' }, { id: 'melintang_kiri_maju_jalan', text: 'Melintang Kiri Maju = JALAN!' } ]},
                { category: 'Berhimpun & Berkumpul', items: [ { id: 'custom_penjuru', text: '(...) sebagai Penjuru!', needsInput: true, isCustomText: true }, { id: 'berhimpun_mulai', text: 'Berhimpun = MULAI!' }, { id: 'bersaf_kumpul_mulai', text: 'Bersaf Kumpul = MULAI!' }, { id: 'berbanjar_kumpul_mulai', text: 'Berbanjar Kumpul = MULAI!' }, { id: 'selesai_himpun_kumpul', text: 'SELESAI!' } ]}
            ],
            TEMPO_DATA: [
                { name: 'Langkah Biasa', bpm: 96, description: 'Tempo standar untuk berjalan biasa (60 cm/langkah).' },
                { name: 'Langkah Tegap', bpm: 96, description: 'Tempo untuk barisan dalam formasi tegap (60 cm/langkah).' },
                { name: 'Langkah Perlahan', bpm: 30, description: 'Tempo lambat untuk upacara (40 cm/langkah).' },
                { name: 'Langkah ke Samping', bpm: 70, description: 'Tempo untuk gerak ke samping (40 cm/langkah).' },
                { name: 'Langkah ke Belakang', bpm: 70, description: 'Tempo untuk gerak ke belakang (40 cm/langkah).' },
                { name: 'Langkah ke Depan', bpm: 70, description: 'Tempo untuk melangkah ke depan dari berhenti (60 cm/langkah).' },
                { name: 'Langkah Lari', bpm: 166, description: 'Tempo cepat untuk gerakan berlari (70 cm/langkah).' },
            ],
            ALL_COMMANDS_FLAT: null,
            
            state: {
                plan: null,
                riwayat: [],
                activePostId: null,
                modalContext: { type: null, targetId: null, insertIndex: -1 },
                currentPage: 'beranda',
                isDirty: false, // Flag untuk autosave
                autosaveInterval: null,
                metronome: null, // Untuk menyimpan state Tone.js
            },
            
            elements: {},
            lastScrollPosition: 0,

            //======================================================================
            // INISIALISASI
            //======================================================================

            init() {
                this.ALL_COMMANDS_FLAT = this.PBB_COMMANDS.flatMap(c => c.items);
                this.state.plan = this.getInitialPlan();
                this.cacheDOMElements();
                this.initTempo(); // Inisialisasi Tone.js
                this.loadStateFromLocalStorage();
                this.bindEventListeners();
                this.checkForSharedPlan();
                this.checkForAutoSave();
                this.renderApp(true);
                this.showWelcomeModal();
                this.state.autosaveInterval = setInterval(this.handleAutoSave.bind(this), 5000); // Autosave setiap 5 detik
            },
            
            cacheDOMElements() {
                this.elements = {
                    appContainer: document.getElementById('app-container'),
                    postsNavList: document.getElementById('posts-nav-list'),
                    workspace: document.getElementById('workspace'),
                    modalContainer: document.getElementById('modal-container'),
                    copyTextBtn: document.getElementById('copy-text-btn'),
                    exportPdfBtn: document.getElementById('export-pdf-btn'),
                    shareBtn: document.getElementById('share-btn'),
                    savePlanBtn: document.getElementById('save-plan-btn'),
                    helperText: document.getElementById('helper-text'),
                    helperBox: document.getElementById('helper-box'),
                    manualCopyArea: document.getElementById('manual-copy-area'),
                    manualCopyTextarea: document.getElementById('manual-copy-textarea'),
                    navButtons: document.querySelectorAll('.nav-btn'),
                    bottomNavButtons: document.querySelectorAll('.bottom-nav-btn'),
                    bottomNav: document.getElementById('bottom-nav'),
                    riwayatListContainer: document.getElementById('riwayat-list'),
                    recentRiwayatList: document.getElementById('recent-riwayat-list'),
                    viewAllHistoryContainer: document.getElementById('view-all-history-container'),
                    planTitle: document.getElementById('plan-title'),
                    planDescription: document.getElementById('plan-description'),
                    planDate: document.getElementById('plan-date'),
                    planLocation: document.getElementById('plan-location'),
                    auroraContainer: document.getElementById('aurora-container'),
                    newPlanBtn: document.getElementById('new-plan-btn'),
                    duplicatePlanBtn: document.getElementById('duplicate-plan-btn'),
                    deletePlanBtn: document.getElementById('delete-plan-btn'),
                    mobileHeaderTitle: document.getElementById('mobile-header-title'),
                    headerLogoBgDesktop: document.getElementById('header-logo-bg-desktop'),
                    headerLogoBgMobile: document.getElementById('header-logo-bg-mobile'),
                    tempoGrid: document.getElementById('tempo-grid'),
                    metronomeStatus: document.getElementById('metronome-status'),
                };
            },

            bindEventListeners() {
                document.addEventListener('input', this.handleGlobalInput.bind(this));
                document.addEventListener('click', this.handleGlobalClick.bind(this));
                
                // Event listeners untuk Drag & Drop
                this.elements.workspace.addEventListener('dragstart', this.handleDragStart.bind(this));
                this.elements.workspace.addEventListener('dragover', this.handleDragOver.bind(this));
                this.elements.workspace.addEventListener('dragleave', this.handleDragLeave.bind(this));
                this.elements.workspace.addEventListener('drop', this.handleDrop.bind(this));
            },

            //======================================================================
            // MANAJEMEN STATE & PENYIMPANAN
            //======================================================================
            
            getInitialPlan: () => ({
                id: null, title: '', description: '', date: '', location: '', posts: []
            }),

            saveStateToLocalStorage() {
                localStorage.setItem('siap_riwayat', JSON.stringify(this.state.riwayat));
            },

            loadStateFromLocalStorage() {
                const savedRiwayat = localStorage.getItem('siap_riwayat');
                if (savedRiwayat) {
                    this.state.riwayat = JSON.parse(savedRiwayat);
                }
            },

            checkForAutoSave() {
                const autosavedPlan = localStorage.getItem('siap_autosave');
                if (autosavedPlan) {
                    const parsedPlan = JSON.parse(autosavedPlan);
                    if (parsedPlan.title || parsedPlan.posts.length > 0) {
                        this.openConfirmationModal(
                            "Ditemukan sesi yang belum disimpan. Apakah Anda ingin memulihkannya?",
                            () => { // onConfirm
                                this.state.plan = parsedPlan;
                                this.state.activePostId = this.state.plan.posts.length > 0 ? this.state.plan.posts[0].id : null;
                                this.state.currentPage = 'editor';
                                this.renderApp(true);
                                this.showToast("Sesi berhasil dipulihkan.");
                            },
                            () => { // onCancel
                                localStorage.removeItem('siap_autosave');
                            }
                        );
                    }
                }
            },

            handleAutoSave() {
                if (this.state.isDirty && this.state.currentPage === 'editor') {
                    if (this.state.plan.title || this.state.plan.posts.length > 0) {
                        localStorage.setItem('siap_autosave', JSON.stringify(this.state.plan));
                        this.state.isDirty = false;
                    }
                }
            },

            checkForSharedPlan() {
                const urlParams = new URLSearchParams(window.location.search);
                const sharedPlanData = urlParams.get('plan');
                if (sharedPlanData) {
                    try {
                        const decodedPlan = JSON.parse(atob(sharedPlanData));
                        this.openConfirmationModal(
                            `Anda menerima rencana "${decodedPlan.title}". Apakah Anda ingin memuatnya ke editor? Pekerjaan saat ini akan ditimpa.`,
                            () => {
                                this.state.plan = decodedPlan;
                                this.state.plan.id = null; // Hapus ID agar tidak menimpa riwayat asli
                                this.state.activePostId = this.state.plan.posts.length > 0 ? this.state.plan.posts[0].id : null;
                                this.state.currentPage = 'editor';
                                this.renderApp(true);
                                this.showToast("Rencana berhasil dimuat.");
                                // Hapus parameter dari URL
                                window.history.replaceState({}, document.title, window.location.pathname);
                            },
                             () => {
                                window.history.replaceState({}, document.title, window.location.pathname);
                            }
                        );
                    } catch (e) {
                        this.showToast("Gagal memuat rencana dari tautan.");
                        console.error("Error decoding shared plan:", e);
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }
            },

            //======================================================================
            // FUNGSI RENDER (MEMPERBARUI UI)
            //======================================================================
            
            renderApp(isPageChange = false) {
                if (isPageChange) {
                    window.scrollTo(0, 0);
                    // Hentikan metronom jika pindah halaman
                    if (this.state.metronome && this.state.metronome.isPlaying) {
                        this.stopMetronome();
                    }
                }
                this.renderPage();
                if (this.state.currentPage === 'beranda') {
                    this.renderRecentRiwayat();
                } else if (this.state.currentPage === 'editor') {
                    this.renderEditorUI();
                } else if (this.state.currentPage === 'riwayat') {
                    this.renderRiwayatPage();
                } else if (this.state.currentPage === 'tempo') {
                    this.renderTempoPage();
                }
            },

            renderEditorUI() {
                this.renderEditorDetails();
                this.renderPostsNav();
                this.renderWorkspace();
                this.updateActionButtonsState();
            },

            updateTheme() {
                const themeClass = `theme-${this.state.currentPage}`;
                const appContainer = this.elements.appContainer;
                appContainer.className = Array.from(appContainer.classList).filter(c => !c.startsWith('theme-')).join(' ');
                appContainer.classList.add(themeClass);

                setTimeout(() => {
                    const themeColor = getComputedStyle(this.elements.appContainer).getPropertyValue('--theme-color-hex').trim();
                    if (this.elements.headerLogoBgDesktop) this.elements.headerLogoBgDesktop.style.backgroundColor = themeColor;
                    if (this.elements.headerLogoBgMobile) this.elements.headerLogoBgMobile.style.backgroundColor = themeColor;
                    if (this.elements.bottomNav) {
                         this.elements.bottomNav.className = Array.from(this.elements.bottomNav.classList).filter(c => !c.startsWith('theme-')).join(' ');
                         this.elements.bottomNav.classList.add(themeClass);
                    }
                }, 0);
            },

            renderPage() {
                this.updateTheme();
                document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
                const activePage = document.getElementById(`page-${this.state.currentPage}`);
                if (activePage) activePage.classList.remove('hidden');

                const pageTitles = {
                    beranda: "Beranda", editor: "Editor", riwayat: "Riwayat", tempo: "Tempo", visualisasi: "Perpang"
                };
                this.elements.mobileHeaderTitle.textContent = pageTitles[this.state.currentPage] || "SIAP!";

                const allNavButtons = [...this.elements.navButtons, ...this.elements.bottomNavButtons];
                allNavButtons.forEach(btn => {
                    const page = btn.dataset.page;
                    if (page) {
                        const isActive = page === this.state.currentPage;
                        btn.classList.toggle('text-theme-focus', isActive);
                        btn.classList.toggle('text-zinc-400', !isActive);
                        const icon = btn.querySelector('svg');
                        const text = btn.querySelector('span');
                        if(icon) icon.classList.toggle('text-theme-focus', isActive);
                        if(text) text.classList.toggle('text-theme-focus', isActive);
                    }
                });
                
                this.elements.helperBox.style.display = this.state.currentPage === 'editor' ? '' : 'none';
            },

            renderEditorDetails() {
                this.elements.planTitle.value = this.state.plan.title;
                this.elements.planDescription.value = this.state.plan.description;
                this.elements.planDate.value = this.state.plan.date;
                this.elements.planLocation.value = this.state.plan.location;
            },

            renderPostsNav() {
                const { postsNavList } = this.elements;
                if (this.state.plan.posts.length === 0) {
                    postsNavList.innerHTML = `<p class="text-sm text-center text-slate-500 py-4">Belum ada pos.</p>`;
                    return;
                }
                const navHTML = this.state.plan.posts.map((post, index) => {
                    const isActive = post.id === this.state.activePostId;
                    const postName = post.name || `POS ${index + 1}`;
                    return this.createHTML.postNavItem(post, postName, isActive);
                }).join('');
                postsNavList.innerHTML = navHTML;
            },

            renderWorkspace() {
                const activePost = this.getActivePost();
                if (!activePost) {
                    this.elements.workspace.innerHTML = this.createHTML.emptyWorkspace();
                    return;
                }
                const postIndex = this.state.plan.posts.findIndex(p => p.id === this.state.activePostId);
                this.elements.workspace.innerHTML = this.createHTML.workspace(activePost, postIndex);
                this.renderMaterials(this.elements.workspace.querySelector('.materials-container'), activePost);
            },

            renderMaterials(container, postData) {
                if (postData.materials.length === 0) {
                    container.innerHTML = `<p class="text-center text-slate-400 py-4">Belum ada materi. Klik tombol di bawah untuk menambahkan.</p>`;
                    return;
                }
                let numberedCounter = 0;
                const materialsHTML = postData.materials.map((material, index) => {
                    if (material.isNumbered) numberedCounter++;
                    return this.createHTML.materialRow(material, index, postData.materials.length, numberedCounter);
                }).join('');
                container.innerHTML = materialsHTML;
            },
            
            renderRiwayatPage() {
                const { riwayatListContainer } = this.elements;
                const { riwayat } = this.state;
                if (riwayat.length === 0) {
                    riwayatListContainer.innerHTML = `<div class="glass-card p-6 rounded-xl text-center"><p class="text-zinc-400">Belum ada riwayat yang tersimpan.</p></div>`;
                    return;
                }
                // Urutkan riwayat dari yang terbaru
                const sortedRiwayat = [...riwayat].sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));
                const riwayatHTML = sortedRiwayat.map(plan => this.createHTML.riwayatItem(plan)).join('');
                riwayatListContainer.innerHTML = riwayatHTML;
            },

            renderRecentRiwayat() {
                const { recentRiwayatList, viewAllHistoryContainer } = this.elements;
                const { riwayat } = this.state;

                if (riwayat.length === 0) {
                    recentRiwayatList.innerHTML = `<p class="text-zinc-400 text-center md:col-span-2 lg:col-span-3">Belum ada riwayat tersimpan.</p>`;
                    viewAllHistoryContainer.classList.add('hidden');
                    return;
                }

                const sortedRiwayat = [...riwayat].sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));
                const recentItems = sortedRiwayat.slice(0, 6);
                
                const riwayatHTML = recentItems.map(plan => this.createHTML.riwayatItem(plan, true)).join('');
                recentRiwayatList.innerHTML = riwayatHTML;
                
                if (riwayat.length > 0) {
                    viewAllHistoryContainer.classList.remove('hidden');
                } else {
                    viewAllHistoryContainer.classList.add('hidden');
                }
            },

            //======================================================================
            // FUNGSI PEMBUAT HTML (TEMPLATE HELPERS)
            //======================================================================
            
            createHTML: {
                postNavItem(post, name, isActive) {
                    return `
                        <button data-post-id="${post.id}" class="w-full text-left p-3 rounded-lg transition-all duration-200 flex justify-between items-center relative ${isActive ? 'bg-zinc-700' : 'hover:bg-zinc-700/50'}">
                            <span class="flex items-center gap-2 ${isActive ? 'font-semibold text-theme-focus' : 'text-zinc-200'}">${name}</span>
                            ${isActive ? '<div class="absolute left-0 top-0 h-full w-1 rounded-r-full" style="background-color: var(--theme-color-focus)"></div>' : ''}
                        </button>`;
                },

                emptyWorkspace() {
                    return `<div class="glass-card rounded-xl shadow-lg flex flex-col items-center justify-center h-full min-h-[400px] text-center p-6 anim-fade-in">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-zinc-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        <h3 class="text-xl font-bold text-slate-200">Tidak Ada Pos yang Dipilih</h3>
                        <p class="mt-2 text-slate-400 max-w-xs">Silakan pilih pos dari daftar di sebelah kiri, atau buat pos baru.</p>
                    </div>`;
                },

                workspace(post, index) {
                    const postTitleHTML = `<input type="text" value="${post.name || ''}" data-field="name" placeholder="Nama Pos ${index + 1}" class="text-2xl font-bold text-theme bg-transparent focus:bg-zinc-700 rounded-lg p-2 w-full -ml-2">`;
                    const sizeParts = [post.size_p, post.size_l, post.turn_width].filter(Boolean);
                    const sizeString = sizeParts.length > 0 ? `${sizeParts.join(' x ')} Meter` : '-';
                    const infoTags = `
                        <div class="flex flex-wrap gap-x-4 gap-y-2">
                            <span class="text-sm text-zinc-300">Ukuran: <b class="font-semibold text-white">${sizeString}</b></span>
                            <span class="text-sm text-zinc-300">Waktu: <b class="font-semibold text-white">${post.time || '-'}</b> Menit</span>
                        </div>`;
                    return `
                        <div class="glass-card relative p-4 sm:p-6 rounded-xl shadow-xl anim-pop-in" data-post-id="${post.id}">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-grow">${postTitleHTML}</div>
                                <div class="flex items-center">
                                    <button class="delete-post-btn text-slate-400 hover:text-red-500 transition-colors p-1 rounded-full" aria-label="Hapus Pos Ini">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between bg-black/20 p-3 rounded-xl">
                                ${infoTags}
                                <button class="edit-size-btn btn btn-primary text-sm font-semibold py-1 px-3 rounded-lg">Atur</button>
                            </div>
                            <hr class="my-4 border-zinc-700/50">
                            <div class="materials-container space-y-2"></div>
                            <div class="mt-4">
                                <button class="add-material-btn btn btn-primary w-full font-semibold py-2 px-4 rounded-lg">+ Tambah Baris Materi</button>
                            </div>
                        </div>`;
                },

                materialRow(material, index, totalMaterials, numberedCounter) {
                    const numberPrefix = material.isNumbered ? `${numberedCounter}.` : '';
                    
                    const movementChips = material.movements.map((mov, movIndex) => {
                        const command = SiapApp.ALL_COMMANDS_FLAT.find(i => i.id === mov.id);
                        if (!command) return '';
                        
                        let chipHTML;
                        if (command.isCustomText) {
                            const parts = command.text.split('(...)');
                            chipHTML = `${parts[0]}<input type="text" value="${mov.count || ''}" placeholder="..." data-movement-index="${movIndex}" class="movement-count-input w-20 text-center bg-transparent font-bold text-theme-focus focus:outline-none">${parts[1]}`;
                        } else if (command.needsInput) {
                            chipHTML = `<input type="number" value="${mov.count || ''}" placeholder="..." data-movement-index="${movIndex}" class="movement-count-input w-10 text-center bg-transparent font-bold text-theme-focus focus:outline-none" ${command.max ? `max="${command.max}"` : ''} min="1"> ${command.text}`;
                        } else {
                            chipHTML = command.text;
                        }

                        return `<div class="movement-chip-wrapper relative group/chip flex items-center">
                                    <span class="bg-black/20 px-3 py-1 rounded-full shadow-sm flex items-center gap-2 text-sm">
                                        ${chipHTML}
                                        <button class="delete-movement-btn absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center opacity-0 group-hover/chip:opacity-100 transition-opacity" data-movement-index="${movIndex}" aria-label="Hapus Gerakan">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                                        </button>
                                    </span>
                                </div>`;
                    });

                    let movementContent = movementChips.reduce((acc, chip, i) => {
                        acc.push(chip);
                        if (i < movementChips.length) {
                            acc.push(`
                                <button class="insert-movement-btn text-zinc-500 hover:text-theme-focus rounded-full opacity-0 group-hover/row:opacity-100 transition-opacity" aria-label="Sisipkan Gerakan" data-insert-index="${i + 1}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                </button>
                            `);
                        }
                        return acc;
                    }, []).join('');


                    if (material.movements.length === 0) {
                        movementContent = `<button class="add-movement-btn text-theme-focus hover:underline">Tambah gerakan...</button>`;
                    }

                    const moveUpBtn = index > 0 ? `<button class="move-material-btn" data-direction="up" aria-label="Naik"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg></button>` : `<div class="w-5"></div>`;
                    const moveDownBtn = index < totalMaterials - 1 ? `<button class="move-material-btn" data-direction="down" aria-label="Turun"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>` : `<div class="w-5"></div>`;

                    return `<div class="material-row group/row relative bg-black/20 p-2 rounded-lg flex items-center gap-2 sm:gap-3 transition-all duration-300" draggable="true" data-material-id="${material.id}">
                        <div class="flex flex-col items-center text-zinc-500 group-hover/row:text-zinc-300 transition-colors cursor-grab">
                            ${moveUpBtn}
                            ${moveDownBtn}
                        </div>
                        <button class="toggle-numbering-btn font-bold text-slate-200 w-6 text-right cursor-pointer" title="Ganti Penomoran">${numberPrefix}</button>
                        <div class="movements-display flex-grow flex flex-wrap items-center gap-1">${movementContent}</div>
                        <div class="flex items-center gap-2 sm:gap-3 ml-auto">
                            ${material.note ? `<span class="text-yellow-500 cursor-help" title="Catatan: ${material.note}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-9a1 1 0 112 0v4a1 1 0 11-2 0V9zm1-4a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" /></svg></span>` : ''}
                            <button class="settings-btn text-zinc-400 hover:text-theme-focus rounded-full p-1" aria-label="Opsi Materi"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z" /></svg></button>
                            <button class="delete-material-btn text-zinc-500 hover:text-red-500 rounded-full p-1" aria-label="Hapus Baris">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                    </div>`;
                },

                riwayatItem(plan, isRecent = false) {
                    const totalPosts = plan.posts.length;
                    const totalMaterials = plan.posts.reduce((acc, post) => acc + post.materials.length, 0);
                    const cardClass = 'riwayat-card glass-card p-4 rounded-xl text-left flex flex-col gap-4 border-l-4 border-theme-focus relative overflow-hidden';
                    const layoutClass = isRecent ? '' : 'sm:flex-row sm:justify-between sm:items-center';
                    return `
                        <div class="${cardClass} ${layoutClass}">
                             <div class="absolute -bottom-8 -right-8 text-white/5 z-0">
                                 <svg width="100" height="100" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M13 3A9 9 0 0 0 4 12H1L4.89 15.89L5 16L9 12H6A7 7 0 0 1 13 5C16.04 5 18.65 6.95 19.58 9.6L21.55 9.03C20.33 5.56 17.03 3 13 3M12 18A7 7 0 0 1 5.42 14.4L3.45 14.97C4.67 18.44 7.97 21 12 21A9 9 0 0 0 21 12H23L19.11 8.11L19 8L15 12H18A7 7 0 0 1 12 18Z" /></svg>
                             </div>
                            <div class="flex-grow z-10">
                                <h3 class="font-bold text-zinc-100">${plan.title || 'Rencana Tanpa Judul'}</h3>
                                <p class="text-sm text-zinc-400 mt-1 line-clamp-2">${plan.description || 'Tidak ada deskripsi'}</p>
                                <div class="text-xs text-zinc-500 mt-2 flex flex-wrap gap-x-4 gap-y-1">
                                    <span>${new Date(plan.savedAt).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                    <span class="font-semibold">${totalPosts} Pos</span>
                                    <span class="font-semibold">${totalMaterials} Materi</span>
                                </div>
                            </div>
                            <div class="flex gap-2 self-end sm:self-center flex-shrink-0 z-10 mt-4 sm:mt-0">
                                <button class="load-riwayat-btn btn btn-primary text-white px-4 py-2 text-sm rounded-lg" data-id="${plan.id}">Muat</button>
                                <button class="delete-riwayat-btn btn bg-zinc-700/80 text-white px-4 py-2 text-sm rounded-lg" data-id="${plan.id}">Hapus</button>
                            </div>
                        </div>`;
                },
                tempoCard(tempo, index, isActive = false) {
                    const playIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>`;
                    const pauseIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
                    
                    return `
                        <div id="tempo-card-${index}" class="glass-card p-5 rounded-xl flex flex-col transition-all duration-300 ${isActive ? 'border-theme-focus' : ''}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-lg font-bold text-zinc-100">${tempo.name}</h3>
                                    <p class="text-theme-focus font-semibold">${tempo.bpm} BPM</p>
                                </div>
                                <button class="tempo-card-btn btn btn-primary rounded-full w-12 h-12 flex items-center justify-center" data-tempo-index="${index}">
                                    ${isActive ? pauseIcon : playIcon}
                                </button>
                            </div>
                            <p class="text-sm text-zinc-400 mt-3 flex-grow">${tempo.description}</p>
                        </div>
                    `;
                }
            },

            //======================================================================
            // FUNGSI MODAL
            //======================================================================

            createModal(id, title, bodyHTML, footerHTML = '', isPdf = false) {
                this.lastScrollPosition = window.scrollY;
                const modalEl = document.createElement('div');
                modalEl.id = id;
                modalEl.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop anim-fade-in';
                const modalSize = isPdf ? 'max-w-5xl w-full h-full max-h-[90vh]' : 'max-w-3xl w-full';
                modalEl.innerHTML = `
                    <div class="glass-card ${modalSize} flex flex-col anim-pop-in rounded-xl" role="dialog" aria-modal="true" aria-labelledby="modal-title-${id}">
                        <header class="p-4 border-b border-zinc-700/50 flex justify-between items-center flex-shrink-0">
                            <h3 id="modal-title-${id}" class="text-xl font-bold text-theme">${title}</h3>
                            <button class="modal-close-btn text-slate-400 hover:text-slate-100" aria-label="Tutup Modal">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </header>
                        <main class="p-4 flex-grow overflow-y-auto">${bodyHTML}</main>
                        ${footerHTML ? `<footer class="p-4 bg-black/20 text-right rounded-b-xl flex-shrink-0">${footerHTML}</footer>` : ''}
                    </div>`;
                
                modalEl.querySelector('.glass-card').classList.add(`theme-${this.state.currentPage}`);
                this.elements.modalContainer.appendChild(modalEl);
                return modalEl;
            },

            closeModal() {
                const modal = this.elements.modalContainer.firstChild;
                if (modal) {
                    modal.classList.remove('anim-fade-in');
                    modal.classList.add('anim-fade-out');
                    modal.querySelector('.glass-card').classList.remove('anim-pop-in');
                    modal.addEventListener('animationend', () => {
                        modal.remove();
                        window.scrollTo(0, this.lastScrollPosition);
                    }, { once: true });
                }
            },

            openCommandModal(contextType, targetId, insertIndex = -1) {
                this.state.modalContext = { type: contextType, targetId, insertIndex };
                const body = `<input type="text" id="modal-search" placeholder="Cari gerakan..." class="form-input w-full p-2 border rounded-lg mb-4">
                                 <div id="modal-command-list" class="max-h-[50vh] overflow-y-auto pr-2"></div>`;
                const modal = this.createModal('command-modal', 'Pilih Gerakan', body);
                this.renderCommandModal();
                modal.querySelector('#modal-search').addEventListener('input', (e) => this.renderCommandModal(e.target.value));
                modal.querySelector('#modal-search').focus();
            },

            renderCommandModal(filter = '') {
                const listEl = document.getElementById('modal-command-list');
                if (!listEl) return;
                const lowerFilter = filter.toLowerCase();
                let html = '';
                this.PBB_COMMANDS.forEach(category => {
                    const filteredItems = category.items.filter(item => item.text.toLowerCase().includes(lowerFilter));
                    if (filteredItems.length > 0) {
                        html += `<h4 class="text-md font-semibold text-theme mb-2 border-b border-zinc-700/50 pb-1">${category.category}</h4>
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">`;
                        filteredItems.forEach(item => {
                            html += `<button class="select-command-btn w-full text-left p-3 bg-zinc-700/50 rounded-lg border border-transparent hover:border-theme-focus hover:bg-theme-20 transition" data-command-id="${item.id}">${item.text}</button>`;
                        });
                        html += `</div>`;
                    }
                });
                listEl.innerHTML = html || `<p class="text-center text-slate-400">Tidak ada gerakan yang cocok dengan pencarian "${filter}".</p>`;
            },

            openContextMenu(materialId) {
                const { material } = this.getMaterialById(materialId);
                if (!material) return;
                const body = `
                    <div class="space-y-3">
                        <label class="flex items-center justify-between p-3 bg-black/20 rounded-lg cursor-pointer"><span class="font-semibold">Dilaksanakan Danton</span><input type="checkbox" name="commanderExecutes" class="form-checkbox h-5 w-5 bg-zinc-600 border-zinc-500 text-theme-focus focus:ring-theme-focus rounded-sm" ${material.commanderExecutes ? 'checked' : ''}/></label>
                        <label class="flex items-center justify-between p-3 bg-black/20 rounded-lg cursor-pointer"><span class="font-semibold">Gunakan Penomoran</span><input type="checkbox" name="isNumbered" class="form-checkbox h-5 w-5 bg-zinc-600 border-zinc-500 text-theme-focus focus:ring-theme-focus rounded-sm" ${material.isNumbered ? 'checked' : ''}/></label>
                        <div class="pt-2">
                            <label class="block text-sm font-medium text-slate-300 mb-1">Catatan</label>
                            <input type="text" name="note" class="form-input mt-1 w-full p-2 border rounded-lg" value="${material.note || ''}" placeholder="misal: Waktu dimulai">
                        </div>
                    </div>`;
                const footer = `<button class="save-context-btn btn btn-primary py-2 px-4 rounded-lg">Simpan & Tutup</button>`;
                const modal = this.createModal('context-menu-modal', 'Opsi Materi', body, footer);
                modal.dataset.materialId = materialId;
            },
            
            openSizeModal(postId) {
                const post = this.state.plan.posts.find(p => p.id === postId);
                if (!post) return;
                const body = `<div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-slate-300 mb-1">Panjang (m)</label><input type="number" value="${post.size_p || ''}" name="size_p" class="form-input w-full p-2 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium text-slate-300 mb-1">Lebar (m)</label><input type="number" value="${post.size_l || ''}" name="size_l" class="form-input w-full p-2 border rounded-lg"></div>
                    </div>
                    <div><label class="block text-sm font-medium text-slate-300 mb-1">Lebar Belokan (m)</label><input type="number" value="${post.turn_width || ''}" name="turn_width" class="form-input w-full p-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium text-slate-300 mb-1">Alokasi Waktu (menit)</label><input type="number" value="${post.time || ''}" name="time" class="form-input w-full p-2 border rounded-lg"></div>
                </div>`;
                const footer = `<button class="save-size-btn btn btn-primary py-2 px-4 rounded-lg">Simpan & Tutup</button>`;
                const modal = this.createModal('size-modal', 'Atur Ukuran & Waktu Pos', body, footer);
                modal.dataset.postId = postId;
            },
            
            openConfirmationModal(message, onConfirm, onCancel = () => {}) {
                const body = `<p class="text-center text-zinc-300">${message}</p>`;
                const footer = `
                    <button id="cancel-action-btn" class="btn bg-zinc-700 text-white px-4 py-2 rounded-lg">Batal</button>
                    <button id="confirm-action-btn" class="btn btn-primary px-4 py-2 rounded-lg">Ya, Lanjutkan</button>
                `;
                const modal = this.createModal('confirmation-modal', 'Konfirmasi Tindakan', body, footer);
                modal.querySelector('#confirm-action-btn').addEventListener('click', () => {
                    onConfirm();
                    this.closeModal();
                }, { once: true });
                modal.querySelector('#cancel-action-btn').addEventListener('click', () => {
                    onCancel();
                    this.closeModal();
                }, { once: true });
            },

            openPdfModal(url, title) {
                const fileIdMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (fileIdMatch && fileIdMatch[1]) {
                    const embedUrl = `https://drive.google.com/file/d/${fileIdMatch[1]}/preview`;
                    const body = `<iframe src="${embedUrl}" class="w-full h-full border-0 rounded-lg" frameborder="0"></iframe>`;
                    this.createModal('pdf-viewer-modal', title, body, '', true);
                } else {
                    this.showToast("URL Google Drive tidak valid.");
                }
            },

            showWelcomeModal() {
                if (sessionStorage.getItem('welcomeShown')) return;
                const body = `<div class="text-center">
                    <span class="text-4xl inline-block">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-theme" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </span>
                    <h3 class="text-xl font-bold mt-4">Selamat Datang di SIAP!</h3>
                    <h4 class="text-lg font-semibold text-theme">Sistem Informasi Aba-aba Peleton</h4>
                    <p class="text-sm text-slate-400 mt-2">
                        Aplikasi ini masih dan akan terus dalam masa pengembangan. 
                        Jika menemukan kekeliruan, error, atau memiliki saran, jangan ragu untuk menghubungi kami melalui tombol di footer.
                    </p>
                </div>`;
                const footer = `<button class="modal-close-btn btn btn-primary py-2 px-6 rounded-lg">Mengerti</button>`;
                this.createModal('welcome-modal', '', body, footer);
                sessionStorage.setItem('welcomeShown', 'true');
            },

            showToast(message, duration = 3000) {
                const toastEl = document.createElement('div');
                toastEl.className = "fixed bottom-20 md:bottom-5 right-5 bg-slate-900 text-white py-3 px-6 rounded-lg shadow-xl transition-all duration-300 transform translate-y-24 opacity-0 z-[100]";
                toastEl.textContent = message;
                document.body.appendChild(toastEl);
                requestAnimationFrame(() => toastEl.classList.remove('translate-y-24', 'opacity-0'));
                setTimeout(() => {
                    toastEl.classList.add('translate-y-24', 'opacity-0');
                    toastEl.addEventListener('transitionend', () => toastEl.remove());
                }, duration);
            },

            //======================================================================
            // FUNGSI HELPER & GETTER
            //======================================================================

            getActivePost() { return this.state.plan.posts.find(p => p.id === this.state.activePostId); },
            
            getMaterialById(materialId) {
                for (const post of this.state.plan.posts) {
                    const material = post.materials.find(m => m.id === materialId);
                    if (material) return { post, material };
                }
                return { post: null, material: null };
            },

            //======================================================================
            // EVENT HANDLER
            //======================================================================

            handleGlobalInput(e) {
                this.state.isDirty = true;
                const { id, value } = e.target;
                if (['plan-title', 'plan-description', 'plan-date', 'plan-location'].includes(id)) {
                    this.state.plan[id.split('-')[1]] = value;
                    this.updateActionButtonsState();
                } else if (e.target.closest('#workspace')) {
                    this.handleWorkspaceInput(e);
                }
            },

            handleWorkspaceInput(e) {
                const post = this.getActivePost();
                if (!post) return;
                if (e.target.dataset.field === 'name') {
                    post.name = e.target.value;
                    this.renderPostsNav();
                }
                const materialRow = e.target.closest('.material-row');
                if (materialRow) {
                    const { material } = this.getMaterialById(materialRow.dataset.materialId);
                    if (material && e.target.matches('.movement-count-input')) {
                        const input = e.target;
                        const max = parseInt(input.getAttribute('max'), 10);
                        let value = input.value;
                        if (max && parseInt(value, 10) > max) {
                            value = max;
                            input.value = value;
                        }
                        material.movements[parseInt(input.dataset.movementIndex, 10)].count = value;
                    }
                }
                this.updateActionButtonsState();
            },

            handleGlobalClick(e) {
                const target = e.target;
                const navBtn = target.closest('.nav-btn, .bottom-nav-btn');
                const openPdfBtn = target.closest('.open-pdf-btn');
                if (navBtn && navBtn.dataset.page) {
                    this.state.currentPage = navBtn.dataset.page;
                    this.renderApp(true);
                    return;
                }
                if (openPdfBtn) {
                    this.openPdfModal(openPdfBtn.dataset.pdfUrl, openPdfBtn.dataset.pdfTitle);
                    return;
                }
                this.delegateClick(target);
            },

            delegateClick(target) {
                const postEl = target.closest('[data-post-id]');
                const materialRow = target.closest('.material-row');
                const actionMap = {
                    '#add-post-btn': this.handleAddPost,
                    '#save-plan-btn': this.handleSavePlan,
                    '#new-plan-btn': this.handleNewPlan,
                    '#duplicate-plan-btn': this.handleDuplicatePlan,
                    '#delete-plan-btn': this.handleDeletePlan,
                    '#copy-text-btn': this.copyToClipboard,
                    '#export-pdf-btn': this.exportToPDF,
                    '#share-btn': this.handleShare,
                };
                for (const selector in actionMap) {
                    if (target.closest(selector)) {
                        actionMap[selector].call(this);
                        return;
                    }
                }
                if (target.closest('#posts-nav-list button')) this.handleSelectPost(target.closest('button').dataset.postId);
                if (target.closest('.load-riwayat-btn')) this.handleLoadPlan(target.closest('button').dataset.id);
                if (target.closest('.delete-riwayat-btn')) this.handleDeleteRiwayat(target.closest('button').dataset.id);
                if (target.closest('.tempo-card-btn')) this.toggleMetronome(parseInt(target.closest('button').dataset.tempoIndex, 10));
                if (postEl) {
                    if (target.closest('.delete-post-btn')) this.handleDeletePost(postEl.dataset.postId);
                    if (target.closest('.edit-size-btn')) this.openSizeModal(postEl.dataset.postId);
                    if (target.closest('.add-material-btn')) this.openCommandModal('newMaterial', postEl.dataset.postId);
                }
                if (materialRow) {
                    if (target.closest('.toggle-numbering-btn')) this.handleToggleNumbering(materialRow.dataset.materialId);
                    if (target.closest('.delete-material-btn')) this.handleDeleteMaterial(materialRow.dataset.materialId);
                    if (target.closest('.delete-movement-btn')) this.handleDeleteMovement(materialRow.dataset.materialId, target.closest('button').dataset.movementIndex);
                    if (target.closest('.move-material-btn')) this.handleMoveMaterial(materialRow.dataset.materialId, target.closest('button').dataset.direction);
                    if (target.closest('.add-movement-btn')) this.openCommandModal('addMovement', materialRow.dataset.materialId);
                    if (target.closest('.insert-movement-btn')) {
                        const insertIndex = parseInt(target.closest('button').dataset.insertIndex, 10);
                        this.openCommandModal('addMovement', materialRow.dataset.materialId, insertIndex);
                    }
                    if (target.closest('.settings-btn')) this.openContextMenu(materialRow.dataset.materialId);
                }
                if (target.closest('.select-command-btn')) this.handleSelectCommand(target.closest('button').dataset.commandId);
                if (target.closest('.save-size-btn')) this.handleSaveSizeModal(target.closest('#size-modal'));
                if (target.closest('.save-context-btn')) this.handleSaveContextMenu(target.closest('#context-menu-modal'));
                if (target.closest('.modal-close-btn') || target.matches('.modal-backdrop')) {
                    this.closeModal();
                }
            },

            //======================================================================
            // HANDLER UNTUK DRAG & DROP
            //======================================================================

            handleDragStart(e) {
                const materialRow = e.target.closest('.material-row');
                if (materialRow) {
                    e.dataTransfer.setData('text/plain', materialRow.dataset.materialId);
                    e.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => materialRow.classList.add('dragging'), 0);
                }
            },

            handleDragOver(e) {
                e.preventDefault();
                const container = e.target.closest('.materials-container');
                if (!container) return; // FIX: Tambahkan guard clause
                const draggingEl = container.querySelector('.dragging');
                if (!draggingEl) return;

                const afterElement = this.getDragAfterElement(container, e.clientY);
                container.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                
                if (afterElement == null) {
                    const lastEl = container.lastElementChild;
                    if(lastEl && !lastEl.classList.contains('dragging')) lastEl.style.borderBottom = '2px solid var(--theme-color-focus)';
                } else {
                    afterElement.classList.add('drag-over');
                }
            },

            handleDragLeave(e) {
                const container = e.target.closest('.materials-container');
                if(container) {
                    container.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    if(container.lastElementChild) container.lastElementChild.style.borderBottom = '';
                }
            },

            handleDrop(e) {
                e.preventDefault();
                const container = e.target.closest('.materials-container');
                if (!container) return;

                const draggedId = e.dataTransfer.getData('text/plain');
                const activePost = this.getActivePost();
                if (!activePost || !draggedId) return;

                const draggingEl = container.querySelector('.dragging');
                if (draggingEl) draggingEl.classList.remove('dragging');
                container.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                if(container.lastElementChild) container.lastElementChild.style.borderBottom = '';

                const fromIndex = activePost.materials.findIndex(m => m.id === draggedId);
                const afterElement = this.getDragAfterElement(container, e.clientY);
                const toIndex = afterElement ? Array.from(container.children).indexOf(afterElement) : activePost.materials.length;

                if (fromIndex !== -1 && fromIndex !== toIndex) {
                    const [removed] = activePost.materials.splice(fromIndex, 1);
                    const correctedToIndex = fromIndex < toIndex ? toIndex - 1 : toIndex;
                    activePost.materials.splice(correctedToIndex, 0, removed);
                    this.state.isDirty = true;
                    this.renderWorkspace();
                }
            },

            getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.material-row:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            },


            //======================================================================
            // HANDLER UNTUK AKSI-AKSI UTAMA
            //======================================================================
            
            handleNewPlan() {
                this.openConfirmationModal("Apakah Anda yakin ingin membuat lembar kerja baru? Perubahan yang belum disimpan akan hilang.", () => {
                    this.state.plan = this.getInitialPlan();
                    this.state.activePostId = null;
                    this.state.isDirty = false;
                    localStorage.removeItem('siap_autosave');
                    this.renderApp(true);
                    this.showToast("Lembar kerja baru telah disiapkan.");
                });
            },
            
            handleAddPost() {
                this.state.isDirty = true;
                const newPost = { id: crypto.randomUUID(), name: '', materials: [] };
                this.state.plan.posts.push(newPost);
                this.state.activePostId = newPost.id;
                this.renderApp();
                this.showToast('Pos baru ditambahkan!');
            },

            handleSelectPost(postId) {
                this.state.activePostId = postId;
                this.renderApp();
            },
            
            handleDeletePost(postId) {
                this.state.isDirty = true;
                const animateAndRemove = (selector, callback) => {
                    const el = document.querySelector(selector);
                    if (el) {
                        el.classList.add('list-item-exit-active');
                        el.addEventListener('transitionend', callback, { once: true });
                    } else { callback(); }
                };
                animateAndRemove(`#posts-nav-list [data-post-id="${postId}"]`, () => {
                    animateAndRemove(`#workspace [data-post-id="${postId}"]`, () => {
                        this.state.plan.posts = this.state.plan.posts.filter(p => p.id !== postId);
                        if (this.state.activePostId === postId) {
                            this.state.activePostId = this.state.plan.posts.length > 0 ? this.state.plan.posts[0].id : null;
                        }
                        this.renderApp();
                        this.showToast('Pos berhasil dihapus.');
                    });
                });
            },

            handleDeleteMaterial(materialId) {
                this.state.isDirty = true;
                const materialRow = document.querySelector(`[data-material-id="${materialId}"]`);
                if (materialRow) {
                    materialRow.classList.add('list-item-exit-active');
                    materialRow.addEventListener('transitionend', () => {
                        const post = this.getActivePost();
                        if (post) {
                            post.materials = post.materials.filter(m => m.id !== materialId);
                            this.renderWorkspace();
                            this.updateActionButtonsState();
                            this.showToast('Materi dihapus.');
                        }
                    }, { once: true });
                }
            },
            
            handleDeleteMovement(materialId, movementIndex) {
                this.state.isDirty = true;
                const { material } = this.getMaterialById(materialId);
                if (material && material.movements[movementIndex]) {
                    material.movements.splice(movementIndex, 1);
                    if (material.movements.length === 0) {
                        this.handleDeleteMaterial(materialId);
                    } else {
                        this.renderWorkspace();
                        this.updateActionButtonsState();
                        this.showToast('Gerakan dihapus.');
                    }
                }
            },
            
            handleMoveMaterial(materialId, direction) {
                this.state.isDirty = true;
                const post = this.getActivePost();
                if (!post) return;
                const index = post.materials.findIndex(m => m.id === materialId);
                if (direction === 'up' && index > 0) {
                    [post.materials[index], post.materials[index - 1]] = [post.materials[index - 1], post.materials[index]];
                } else if (direction === 'down' && index < post.materials.length - 1) {
                    [post.materials[index], post.materials[index + 1]] = [post.materials[index + 1], post.materials[index]];
                }
                this.renderWorkspace();
                this.showToast('Urutan materi diubah.');
            },

            handleToggleNumbering(materialId) {
                const { material } = this.getMaterialById(materialId);
                if (material) {
                    material.isNumbered = !material.isNumbered;
                    this.state.isDirty = true;
                    this.renderWorkspace();
                }
            },

            handleSelectCommand(commandId) {
                this.state.isDirty = true;
                const command = this.ALL_COMMANDS_FLAT.find(i => i.id === commandId);
                if (!command) return;

                const newMovement = { id: commandId, ...(command.needsInput && { count: '' }) };
                let targetMaterial, targetPost;
                const { type, targetId, insertIndex } = this.state.modalContext;

                if (type === 'newMaterial') {
                    targetPost = this.state.plan.posts.find(p => p.id === targetId);
                    if (targetPost) {
                        const newMaterial = { id: crypto.randomUUID(), movements: [newMovement], commanderExecutes: false, note: '', isNumbered: true };
                        targetPost.materials.push(newMaterial);
                        targetMaterial = newMaterial;
                        this.showToast('Materi baru ditambahkan.');
                    }
                } else if (type === 'addMovement') {
                    const { post, material } = this.getMaterialById(targetId);
                    if (material) {
                        if (insertIndex > -1) {
                            material.movements.splice(insertIndex, 0, newMovement);
                        } else {
                            material.movements.push(newMovement);
                        }
                        targetMaterial = material;
                        targetPost = post;
                        this.showToast('Gerakan ditambahkan.');
                    }
                }

                if (targetMaterial && targetPost) {
                    this.applyCommandLogic(commandId, targetMaterial, targetPost);
                }
                
                this.renderWorkspace();
                this.closeModal();
                this.updateActionButtonsState();
            },

            applyCommandLogic(commandId, material, post) {
                this.state.isDirty = true;
                const addChainedCommand = (id) => {
                    const chainedCommand = this.ALL_COMMANDS_FLAT.find(c => c.id === id);
                    if (chainedCommand) {
                        material.movements.push({ id: chainedCommand.id });
                    }
                };

                const prependCommand = (id) => {
                    const prependedCommand = this.ALL_COMMANDS_FLAT.find(c => c.id === id);
                    if(prependedCommand) {
                        material.movements.unshift({ id: prependedCommand.id, isCustomText: true, count: '' });
                    }
                }

                // Otomatisasi
                const autoChainMap = {
                    'custom_honor_jury': 'tegak_gerak',
                    'hormat_gerak': 'tegak_gerak',
                    'hormat_kanan_gerak': 'tegak_gerak',
                    'hormat_kiri_gerak': 'tegak_gerak',
                    'lencang_kanan_gerak': 'tegak_gerak',
                    'lencang_kiri_gerak': 'tegak_gerak',
                    'setengah_lengan_lencang_kanan_gerak': 'tegak_gerak',
                    'setengah_lengan_lencang_kiri_gerak': 'tegak_gerak',
                    'lencang_depan_gerak': 'tegak_gerak',
                    'periksa_kerapian_mulai': 'periksa_kerapian_selesai',
                    'parade_periksa_kerapian_mulai': 'periksa_kerapian_selesai',
                    'berhimpun_mulai': 'selesai_himpun_kumpul',
                    'untuk_perhatian': 'istirahat_ditempat_gerak',
                    'haluan_kanan_jalan': 'henti_gerak_berjalan',
                    'haluan_kiri_jalan': 'henti_gerak_berjalan',
                    'melintang_kanan_jalan': 'henti_gerak_berjalan',
                    'melintang_kiri_jalan': 'henti_gerak_berjalan',
                    'haluan_kanan_maju_jalan': 'maju_jalan',
                    'haluan_kiri_maju_jalan': 'maju_jalan',
                    'melintang_kanan_maju_jalan': 'maju_jalan',
                    'melintang_kiri_maju_jalan': 'maju_jalan',
                };
                if (autoChainMap[commandId]) {
                    addChainedCommand(autoChainMap[commandId]);
                }

                if (commandId === 'bersaf_kumpul_mulai' || commandId === 'berbanjar_kumpul_mulai') {
                    prependCommand('custom_penjuru');
                    addChainedCommand('selesai_himpun_kumpul');
                }
            },
            
            handleSaveSizeModal(modal) {
                this.state.isDirty = true;
                const postId = modal.dataset.postId;
                const post = this.state.plan.posts.find(p => p.id === postId);
                if(post) {
                    modal.querySelectorAll('input[name]').forEach(input => { post[input.name] = input.value; });
                    this.showToast("Ukuran pos disimpan.");
                    this.renderWorkspace();
                }
                this.closeModal();
            },

            handleSaveContextMenu(modal) {
                this.state.isDirty = true;
                const materialId = modal.dataset.materialId;
                const { material } = this.getMaterialById(materialId);
                if (material) {
                    modal.querySelectorAll('input[name]').forEach(input => { material[input.name] = input.type === 'checkbox' ? input.checked : input.value; });
                    this.showToast("Opsi materi disimpan.");
                    this.renderWorkspace();
                }
                this.closeModal();
            },
            
            handleSavePlan() {
                const error = this.getPlanValidationErrors(false); // Validasi tidak ketat
                if (error) { this.showToast(`Gagal menyimpan: ${error}`); return; }
                const planToSave = JSON.parse(JSON.stringify(this.state.plan));
                planToSave.savedAt = new Date().toISOString();
                if (planToSave.id) {
                    const index = this.state.riwayat.findIndex(p => p.id === planToSave.id);
                    if (index > -1) this.state.riwayat[index] = planToSave;
                    else this.state.riwayat.unshift(planToSave);
                } else {
                    planToSave.id = crypto.randomUUID();
                    this.state.plan.id = planToSave.id; 
                    this.state.riwayat.unshift(planToSave);
                }
                this.saveStateToLocalStorage();
                this.state.isDirty = false;
                localStorage.removeItem('siap_autosave');
                this.showToast(`Rencana "${planToSave.title}" berhasil disimpan!`);
                this.renderRiwayatPage();
                this.renderRecentRiwayat(); // Update juga di beranda
            },

            handleLoadPlan(planId) {
                this.openConfirmationModal("Memuat rencana akan menimpa pekerjaan saat ini. Lanjutkan?", () => {
                    const planToLoad = this.state.riwayat.find(p => p.id === planId);
                    if (planToLoad) {
                        this.state.plan = JSON.parse(JSON.stringify(planToLoad));
                        this.state.activePostId = this.state.plan.posts.length > 0 ? this.state.plan.posts[0].id : null;
                        this.state.currentPage = 'editor';
                        this.state.isDirty = false;
                        localStorage.removeItem('siap_autosave');
                        this.renderApp(true);
                        this.showToast(`Rencana "${this.state.plan.title}" dimuat.`);
                    }
                });
            },

            handleDeleteRiwayat(planId) {
                this.openConfirmationModal("Apakah Anda yakin ingin menghapus rencana ini dari riwayat? Tindakan ini tidak dapat diurungkan.", () => {
                    this.state.riwayat = this.state.riwayat.filter(p => p.id !== planId);
                    this.saveStateToLocalStorage();
                    this.renderRiwayatPage();
                    this.renderRecentRiwayat(); // Update juga di beranda
                    this.showToast("Rencana telah dihapus dari riwayat.");
                });
            },

            handleDuplicatePlan() {
                if (!this.state.plan.id) {
                    this.showToast('Simpan rencana terlebih dahulu untuk duplikasi.');
                    return;
                }
                this.openConfirmationModal("Menduplikasi akan menimpa pekerjaan saat ini dengan salinan baru. Lanjutkan?", () => {
                    const newPlan = JSON.parse(JSON.stringify(this.state.plan));
                    newPlan.id = crypto.randomUUID();
                    newPlan.title = `${newPlan.title} (Salinan)`;
                    newPlan.savedAt = new Date().toISOString();
                    this.state.riwayat.unshift(newPlan);
                    this.saveStateToLocalStorage();
                    this.state.plan = newPlan;
                    this.state.activePostId = this.state.plan.posts.length > 0 ? this.state.plan.posts[0].id : null;
                    this.state.isDirty = false;
                    localStorage.removeItem('siap_autosave');
                    this.renderApp(true);
                    this.showToast(`Rencana diduplikasi dan dimuat sebagai "${newPlan.title}".`);
                });
            },
            
            handleDeletePlan() {
                 this.openConfirmationModal("Apakah Anda yakin ingin menghapus seluruh isi editor saat ini? Tindakan ini tidak dapat diurungkan.", () => {
                    this.state.plan = this.getInitialPlan();
                    this.state.activePostId = null;
                    this.state.isDirty = false;
                    localStorage.removeItem('siap_autosave');
                    this.renderApp();
                    this.showToast("Editor telah dibersihkan.");
                });
            },
            
            //======================================================================
            // FUNGSI TEMPO / METRONOME
            //======================================================================
            initTempo() {
                const synth = new Tone.Synth({
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
                }).toDestination();
                
                const loop = new Tone.Loop(time => {
                    synth.triggerAttackRelease("C5", "8n", time);
                    // Visual feedback
                    const activeCard = document.getElementById(`tempo-card-${this.state.metronome.activeCard}`);
                    if (activeCard) {
                        activeCard.style.transform = 'scale(1.03)';
                        setTimeout(() => { activeCard.style.transform = 'scale(1)'; }, 100);
                    }
                }, "4n");

                this.state.metronome = { synth, loop, isPlaying: false, activeCard: null };
            },

            renderTempoPage() {
                this.elements.tempoGrid.innerHTML = this.TEMPO_DATA.map((tempo, index) => {
                    const isActive = this.state.metronome.isPlaying && this.state.metronome.activeCard === index;
                    return this.createHTML.tempoCard(tempo, index, isActive);
                }).join('');
                this.updateTempoUI();
            },

            toggleMetronome(index) {
                const { metronome } = this.state;
                const tempoData = this.TEMPO_DATA[index];

                if (metronome.isPlaying && metronome.activeCard === index) {
                    this.stopMetronome();
                } else {
                    if (metronome.isPlaying) {
                        this.stopMetronome();
                    }
                    // Start Tone.js context on user interaction
                    Tone.start();
                    Tone.Transport.bpm.value = tempoData.bpm;
                    metronome.loop.start(0);
                    Tone.Transport.start();
                    metronome.isPlaying = true;
                    metronome.activeCard = index;
                    this.updateTempoUI();
                }
            },

            stopMetronome() {
                const { metronome } = this.state;
                if (metronome.isPlaying) {
                    Tone.Transport.stop();
                    metronome.loop.stop();
                    metronome.isPlaying = false;
                    metronome.activeCard = null;
                    this.updateTempoUI();
                }
            },

            updateTempoUI() {
                const { metronome } = this.state;
                const { metronomeStatus } = this.elements;
                
                // Update status text
                if (metronome.isPlaying) {
                    const currentTempo = this.TEMPO_DATA[metronome.activeCard];
                    metronomeStatus.innerHTML = `Sedang memainkan: <b class="text-theme-focus">${currentTempo.name} (${currentTempo.bpm} BPM)</b>`;
                } else {
                    metronomeStatus.textContent = 'Metronom berhenti. Pilih salah satu tempo untuk memulai.';
                }

                // Update all cards
                this.TEMPO_DATA.forEach((tempo, index) => {
                    const card = document.getElementById(`tempo-card-${index}`);
                    if (card) {
                        const isActive = metronome.isPlaying && metronome.activeCard === index;
                        card.classList.toggle('border-theme-focus', isActive);
                        card.classList.toggle('bg-theme-20', isActive);
                        const btn = card.querySelector('.tempo-card-btn');
                        if (btn) {
                            btn.innerHTML = this.createHTML.tempoCard(tempo, index, isActive).match(/<button.*?>([\s\S]*)<\/button>/)[1];
                        }
                    }
                });
            },


            //======================================================================
            // FUNGSI UTILITAS & EKSPOR
            //======================================================================
            
            getPlanValidationErrors(isStrict = false) {
                if (!this.state.plan.title) return "Judul aba-aba belum diisi.";
                if (isStrict) {
                    if (this.state.plan.posts.length === 0) return "Belum ada pos yang dibuat.";
                    for (const [index, post] of this.state.plan.posts.entries()) {
                        const postName = post.name || `Pos ${index + 1}`;
                        if (!post.size_p || !post.size_l || !post.time) return `Ukuran atau waktu untuk '${postName}' belum lengkap.`;
                        if (post.materials.length === 0) return `Pos '${postName}' belum memiliki materi.`;
                    }
                }
                return null;
            },

            updateActionButtonsState() {
                if (this.state.currentPage !== 'editor' || !this.elements.savePlanBtn) return;
                const saveError = this.getPlanValidationErrors(false);
                const exportError = this.getPlanValidationErrors(true);
                
                this.elements.savePlanBtn.disabled = (saveError !== null);

                const exportButtons = [ this.elements.copyTextBtn, this.elements.exportPdfBtn, this.elements.shareBtn, this.elements.duplicatePlanBtn ];
                exportButtons.forEach(btn => { if (btn) { btn.disabled = (exportError !== null); } });
                
                if (this.elements.manualCopyArea) {
                    this.elements.manualCopyArea.classList.add('hidden');
                }

                let message = "Selamat datang! Siap untuk merancang?";
                const error = saveError || exportError;
                if (error) { message = error; } 
                else { message = "Rencana sudah lengkap! Anda dapat menyimpan atau mengekspor sekarang."; }
                
                const activePost = this.getActivePost();
                if (this.state.plan.posts.length > 0 && !activePost) { message = "Pilih sebuah pos dari daftar di samping untuk melanjutkan."; } 
                else if (this.state.plan.posts.length === 0 && this.state.plan.title) { message = "Rencana Anda masih kosong. Tambahkan pos pertama untuk memulai."; } 
                else if (activePost && activePost.materials.length === 0) { message = `Pos "${activePost.name || 'Baru'}" masih kosong. Tambahkan materi pertama Anda.`; }
                this.elements.helperText.innerHTML = message;
            },
            
            generatePlanContent(format = 'text') {
                let output = '';
                const { title, description, date, location, posts } = this.state.plan;
                if (format === 'html') {
                    output += `<h1 style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${title || 'Rencana Latihan'}</h1>`;
                    if (description) output += `<p style="font-style: italic; margin-bottom: 10px;">${description}</p>`;
                    if (date || location) output += `<p style="font-size: 14px; margin-bottom: 15px;"><b>Tanggal:</b> ${date || '-'} | <b>Lokasi:</b> ${location || '-'}</p>`;
                } else {
                    const details = [title ? title.toUpperCase() : '', description, date ? `Tanggal: ${date}` : '', location ? `Lokasi: ${location}` : ''].filter(Boolean);
                    if (details.length > 0) output += details.join('\n') + '\n\n';
                }
                posts.forEach((post, index) => {
                    const postTitle = post.name || `POS ${index + 1}`;
                    const sizeParts = [post.size_p, post.size_l, post.turn_width].filter(Boolean);
                    const sizeString = sizeParts.length > 0 ? `${sizeParts.join(' x ')} Meter` : '-';
                    let sizeDetails = `Ukuran: ${sizeString} | Waktu: ${post.time || '-'} Menit`;
                    if (format === 'html') {
                        output += `<hr style="margin: 15px 0;"><h2 style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">${postTitle}</h2><p style="font-size: 14px; margin-bottom: 10px;">${sizeDetails}</p><div style="margin-left: 5mm;">`;
                    } else {
                        output += `--- ${postTitle} ---\n${sizeDetails}\n\n`;
                    }
                    let numberedCounter = 0;
                    post.materials.forEach(material => {
                        if (material.isNumbered) numberedCounter++;
                        const line = material.movements.map(mov => {
                            const command = this.ALL_COMMANDS_FLAT.find(i => i.id === mov.id);
                            if (!command) return null;
                            if(command.isCustomText) {
                                return command.text.replace('(...)', `(${mov.count || '...'})`);
                            }
                            return command.needsInput && mov.count ? `${mov.count} ${command.text}` : command.text;
                        }).filter(Boolean).join('  ');
                        let finalLine = line;
                        if (material.note) finalLine += ` (${material.note})`;
                        if (material.commanderExecutes) finalLine = format === 'html' ? `<b>${finalLine}</b>` : `*${finalLine}*`;
                        if (finalLine) {
                            const prefix = material.isNumbered ? `${numberedCounter}.` : '';
                            output += format === 'html' ? `<p style="font-size: 16px; margin-bottom: 5px;">${prefix} ${finalLine}</p>` : `${prefix}\t${finalLine}\n`;
                        }
                    });
                    output += format === 'html' ? '</div>' : '\n';
                });
                return output.trim();
            },

            copyTextToClipboard(text) {
                const textArea = document.createElement("textarea");
                textArea.style.position = 'fixed';
                textArea.style.top = 0;
                textArea.style.left = 0;
                textArea.style.width = '2em';
                textArea.style.height = '2em';
                textArea.style.padding = 0;
                textArea.style.border = 'none';
                textArea.style.outline = 'none';
                textArea.style.boxShadow = 'none';
                textArea.style.background = 'transparent';
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                let successful = false;
                try {
                    successful = document.execCommand('copy');
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }
                document.body.removeChild(textArea);
                return successful;
            },

            async copyToClipboard() {
                const error = this.getPlanValidationErrors(true);
                if (error) { this.showToast(`Gagal: ${error}`); return; }
                const textToCopy = this.generatePlanContent('text');
                if (!this.copyTextToClipboard(textToCopy)) {
                    this.elements.helperText.innerHTML = `<strong>Gagal menyalin otomatis!</strong><br>Silakan salin teks dari kotak di bawah ini.`;
                    this.elements.manualCopyTextarea.value = textToCopy;
                    this.elements.manualCopyArea.classList.remove('hidden');
                    this.elements.manualCopyTextarea.select();
                } else {
                    this.showToast('Rencana berhasil disalin!');
                }
            },

            exportToPDF() {
                const error = this.getPlanValidationErrors(true);
                if (error) { this.showToast(`Gagal: ${error}`); return; }
                this.showToast('Membuat PDF...');
                const { jsPDF } = window.jspdf;
                const printArea = document.getElementById('print-area');
                printArea.innerHTML = this.generatePlanContent('html');
                printArea.classList.remove('hidden');

                html2canvas(printArea, { scale: 2, useCORS: true }).then(canvas => {
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgData = canvas.toDataURL('image/png');
                    const pageHeight = pdf.internal.pageSize.getHeight() - 20;
                    const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    let heightLeft = pdfHeight;
                    let position = 10;
                    pdf.addImage(imgData, 'PNG', 10, position, pdfWidth, pdfHeight);
                    heightLeft -= pageHeight;
                    while (heightLeft > 0) {
                        position = -heightLeft + 10;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 10, position, pdfWidth, pdfHeight);
                        heightLeft -= pageHeight;
                    }
                    pdf.save(`${this.state.plan.title || 'rencana-latihan'}.pdf`);
                    printArea.classList.add('hidden');
                }).catch(err => {
                    this.showToast('Gagal membuat PDF.');
                    console.error("PDF Export error:", err);
                    printArea.classList.add('hidden');
                });
            },
            
            async handleShare() {
                const error = this.getPlanValidationErrors(true);
                if (error) { this.showToast(`Gagal: ${error}`); return; }
                
                const cleanPlan = JSON.parse(JSON.stringify(this.state.plan));
                cleanPlan.id = null;
                cleanPlan.posts.forEach(post => {
                    post.id = crypto.randomUUID();
                    post.materials.forEach(mat => mat.id = crypto.randomUUID());
                });

                const planString = JSON.stringify(cleanPlan);
                const encodedPlan = btoa(planString);
                const shareUrl = `${window.location.origin}${window.location.pathname}?plan=${encodedPlan}`;

                const shareData = {
                    title: `Rencana Latihan: ${this.state.plan.title || 'Tanpa Judul'}`,
                    text: `Lihat rencana aba-aba "${this.state.plan.title}" yang saya buat dengan SIAP!`,
                    url: shareUrl,
                };

                try {
                    if (navigator.share) {
                        await navigator.share(shareData);
                        this.showToast('Rencana berhasil dibagikan!');
                    } else {
                        if(this.copyTextToClipboard(shareUrl)) {
                            this.showToast('Tautan berbagi disalin ke clipboard!');
                        } else {
                            this.showToast('Gagal menyalin tautan.');
                        }
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') { 
                        this.showToast('Gagal membagikan. Tautan disalin.');
                        this.copyTextToClipboard(shareUrl);
                    }
                }
            },
        };

        // Mulai aplikasi
        SiapApp.init();
    });
    </script>
</body>
</html>
