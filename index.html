<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penyusun Rencana Latihan PBB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .btn-primary {
            background-color: #9f1239; /* rose-800 */
            color: white;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #881337; /* rose-900 */
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(0,0,0,0.1);
        }
        .btn-secondary {
            background-color: #e5e7eb; /* gray-200 */
            color: #374151; /* gray-700 */
             transition: all 0.2s ease-in-out;
        }
         .btn-secondary:hover {
            background-color: #d1d5db; /* gray-300 */
        }
        .modal-backdrop {
            background-color: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(4px);
        }
        .material-row .contextual-controls {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .material-row:hover .contextual-controls {
            opacity: 1;
            visibility: visible;
        }
        .movement-chip {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .flash-success {
            animation: flash 0.7s ease-out;
        }
        @keyframes flash {
            0% { background-color: #fecdd3; } /* rose-100 */
            100% { background-color: transparent; }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #fda4af; /* rose-300 */ border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #f43f5e; /* rose-500 */ }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="text-center py-12 sm:py-16">
            <div class="mx-auto mb-6 w-16 h-16 rounded-2xl bg-rose-800 text-white flex items-center justify-center text-3xl shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                </svg>
            </div>
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tight text-gray-900">
                Penyusun Aba-aba materi
            </h1>
            <p class="mt-4 text-base sm:text-lg text-gray-600 max-w-2xl mx-auto">
                oleh 1nspketur - Tonti Mu'allimin
            </p>
        </header>

        <!-- Global Details -->
        <div class="bg-white p-6 rounded-2xl shadow-xl mb-8">
            <h2 class="text-xl font-bold mb-4 text-rose-800">Detail Informasi Latihan</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="plan-title" placeholder="Judul Rencana (misal: Latihan PBB Dasar Minggu 1)" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-rose-500">
                <input type="text" id="plan-description" placeholder="Deskripsi (opsional)" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-rose-500">
            </div>
             <div class="mt-6 pt-4 border-t flex flex-wrap gap-3 justify-center">
                 <button id="play-all-btn" class="flex items-center justify-center gap-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition disabled:bg-slate-400 shadow-md hover:shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    Putar Semua
                </button>
                <button id="copy-plan-btn" class="flex items-center justify-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition disabled:bg-slate-400 shadow-md hover:shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    Salin Rencana
                </button>
                <button id="reset-plan-btn" class="flex items-center justify-center gap-2 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition disabled:bg-slate-400 shadow-md hover:shadow-lg">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                    Reset Semua
                </button>
            </div>
        </div>

        <!-- Posts Container -->
        <div id="posts-container" class="space-y-8">
            <!-- Posts will be rendered here -->
        </div>
        <button id="add-post-btn" class="w-full mt-8 btn-primary font-bold py-4 px-4 rounded-lg text-lg">
            + Tambah Pos Baru
        </button>

    </div>

    <!-- Command Selection Modal -->
    <div id="command-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-rose-800">Pilih Gerakan</h3>
                <button id="modal-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div class="p-4">
                 <input type="text" id="modal-search" placeholder="Cari gerakan..." class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-rose-500">
            </div>
            <div id="modal-command-list" class="p-4 pt-0 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-900 text-white py-3 px-6 rounded-lg shadow-xl translate-y-24 opacity-0 transition-all duration-300">
        <p id="toast-message">Pesan notifikasi</p>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA ---
        const PBB_COMMANDS = [
            { category: 'Sikap Sempurna & Istirahat', items: [ { id: 'siap_gerak', text: 'Siap = GERAK!' }, { id: 'parade_siap_gerak', text: 'Parade, Siap = GERAK!' }, { id: 'duduk_siap_gerak', text: 'Duduk Siap = GERAK!' }, { id: 'istirahat_ditempat_gerak', text: 'Istirahat di Tempat = GERAK!' }, { id: 'parade_istirahat_ditempat_gerak', text: 'Parade, Istirahat di Tempat = GERAK!' }, { id: 'untuk_perhatian', text: 'Untuk Perhatian!' } ] },
            { category: 'Lencang & Tegak', items: [ { id: 'lencang_kanan_gerak', text: 'Lencang Kanan = GERAK!' }, { id: 'lencang_kiri_gerak', text: 'Lencang Kiri = GERAK!' }, { id: 'setengah_lengan_lencang_kanan_gerak', text: 'Setengah Lengan Lencang Kanan = GERAK!' }, { id: 'setengah_lengan_lencang_kiri_gerak', text: 'Setengah Lengan Lencang Kiri = GERAK!' }, { id: 'lencang_depan_gerak', text: 'Lencang Depan = GERAK!' }, { id: 'tegak_gerak', text: 'Tegak = GERAK!' } ] },
            { category: 'Penghormatan', items: [ { id: 'hormat_gerak', text: 'Hormat = GERAK!' }, { id: 'hormat_kanan_gerak', text: 'Hormat Kanan = GERAK!' }, { id: 'hormat_kiri_gerak', text: 'Hormat Kiri = GERAK!' } ] },
            { category: 'Berhitung', items: [ { id: 'hitung_mulai', text: 'Hitung = MULAI!' } ] },
            { category: 'Periksa Kerapihan', items: [ { id: 'periksa_kerapian_mulai', text: 'Periksa Kerapian = MULAI!' }, { id: 'periksa_kerapian_selesai', text: 'SELESAI!' }, { id: 'parade_periksa_kerapian_mulai', text: 'Parade Periksa Kerapian = MULAI!' } ] },
            { category: 'Buka & Tutup Barisan', items: [ { id: 'buka_barisan_jalan', text: 'Buka Barisan = JALAN!' }, { id: 'tutup_barisan_jalan', text: 'Tutup Barisan = JALAN!' } ] },
            { category: 'Perubahan Arah (Di Tempat)', items: [ { id: 'hadap_kanan_gerak', text: 'Hadap Kanan = GERAK!' }, { id: 'hadap_kiri_gerak', text: 'Hadap Kiri = GERAK!' }, { id: 'hadap_serong_kanan_gerak', text: 'Hadap Serong Kanan = GERAK!' }, { id: 'hadap_serong_kiri_gerak', text: 'Hadap Serong Kiri = GERAK!' }, { id: 'balik_kanan_gerak', text: 'Balik Kanan = GERAK!' } ] },
            { category: 'Bubar', items: [ { id: 'bubar_jalan', text: 'Bubar = JALAN!' } ] },
            { category: 'Jalan di Tempat', items: [ { id: 'jalan_ditempat_gerak', text: 'Jalan di Tempat = GERAK!' }, { id: 'henti_gerak_ditempat', text: 'Henti = GERAK!' } ] },
            { category: 'Gerakan Berjalan (Mulai & Berhenti)', items: [
                { id: 'maju_jalan', text: 'Maju = JALAN!' },
                { id: 'langkah_tegap_maju_jalan', text: 'Langkah Tegap Maju = JALAN!' },
                { id: 'langkah_perlahan_maju_jalan', text: 'Langkah Perlahan Maju = JALAN!' },
                { id: 'langkah_ke_kanan_jalan', text: 'Langkah ke Kanan = JALAN!', needsInput: true },
                { id: 'langkah_ke_kiri_jalan', text: 'Langkah ke Kiri = JALAN!', needsInput: true },
                { id: 'langkah_ke_belakang_jalan', text: 'Langkah ke Belakang = JALAN!', needsInput: true },
                { id: 'langkah_ke_depan_jalan', text: 'Langkah ke Depan = JALAN!', needsInput: true },
                { id: 'henti_gerak_berjalan', text: 'Henti = GERAK!' },
            ]},
            { category: 'Gerakan Berlari (Mulai & Berhenti)', items: [
                { id: 'lari_maju_jalan', text: 'Lari Maju = JALAN!' },
                { id: 'lari_jalan', text: 'Lari = JALAN!' },
                { id: 'henti_gerak_berlari', text: 'Henti = GERAK!' },
            ]},
            { category: 'Gerakan Transisi (Berjalan & Berlari)', items: [
                { id: 'langkah_tegap_jalan', text: 'Langkah Tegap = JALAN!' },
                { id: 'langkah_biasa_jalan', text: 'Langkah Biasa = JALAN!' },
                { id: 'langkah_perlahan_jalan', text: 'Langkah Perlahan = JALAN!' },
                { id: 'langkah_merdeka_jalan', text: 'Langkah Merdeka = JALAN!' },
                { id: 'ganti_langkah_jalan', text: 'Ganti Langkah = JALAN!' },
            ]},
            { category: 'Perubahan Arah (Berjalan)', items: [
                { id: 'hadap_kanan_maju_jalan', text: 'Hadap Kanan Maju = JALAN!' },
                { id: 'hadap_kiri_maju_jalan', text: 'Hadap Kiri Maju = JALAN!' },
                { id: 'hadap_serong_kanan_maju_jalan', text: 'Hadap Serong Kanan Maju = JALAN!' },
                { id: 'hadap_serong_kiri_maju_jalan', text: 'Hadap Serong Kiri Maju = JALAN!' },
                { id: 'balik_kanan_maju_jalan', text: 'Balik Kanan Maju = JALAN!' },
                { id: 'belok_kanan_jalan', text: 'Belok Kanan = JALAN!' },
                { id: 'belok_kiri_jalan', text: 'Belok Kiri = JALAN!' },
                { id: 'dua_kali_belok_kanan_jalan', text: 'Dua Kali Belok Kanan = JALAN!' },
                { id: 'dua_kali_belok_kiri_jalan', text: 'Dua Kali Belok Kiri = JALAN!' },
                { id: 'tiap_tiap_banjar_2x_belok_kanan_jalan', text: 'Tiap-tiap Banjar Dua Kali Belok Kanan = JALAN!' },
                { id: 'tiap_tiap_banjar_2x_belok_kiri_jalan', text: 'Tiap-tiap Banjar Dua Kali Belok Kiri = JALAN!' },
            ]},
            { category: 'Perubahan Arah (Berjalan ke Berhenti)', items: [
                { id: 'hadap_kanan_henti_gerak', text: 'Hadap Kanan Henti = GERAK!' },
                { id: 'hadap_kiri_henti_gerak', text: 'Hadap Kiri Henti = GERAK!' },
                { id: 'hadap_serong_kanan_henti_gerak', text: 'Hadap Serong Kanan Henti = GERAK!' },
                { id: 'hadap_serong_kiri_henti_gerak', text: 'Hadap Serong Kiri Henti = GERAK!' },
                { id: 'balik_kanan_henti_gerak', text: 'Balik Kanan Henti = GERAK!' },
            ]},
             { category: 'Perubahan Arah (Berlari)', items: [
                { id: 'hadap_kanan_lari_maju_jalan', text: 'Hadap Kanan Lari Maju = JALAN!' },
                { id: 'hadap_kiri_lari_maju_jalan', text: 'Hadap Kiri Lari Maju = JALAN!' },
                { id: 'hadap_serong_kanan_lari_maju_jalan', text: 'Hadap Serong Kanan Lari Maju = JALAN!' },
                { id: 'hadap_serong_kiri_lari_maju_jalan', text: 'Hadap Serong Kiri Lari Maju = JALAN!' },
                { id: 'balik_kanan_lari_maju_jalan', text: 'Balik Kanan Lari Maju = JALAN!' },
            ]},
             { category: 'Perubahan Arah (Berlari ke Berhenti)', items: [
                { id: 'hadap_kanan_lari_henti_gerak', text: 'Hadap Kanan Henti = GERAK!' },
                { id: 'hadap_kiri_lari_henti_gerak', text: 'Hadap Kiri Henti = GERAK!' },
                { id: 'hadap_serong_kanan_lari_henti_gerak', text: 'Hadap Serong Kanan Henti = GERAK!' },
                { id: 'hadap_serong_kiri_lari_henti_gerak', text: 'Hadap Serong Kiri Henti = GERAK!' },
                { id: 'balik_kanan_lari_henti_gerak', text: 'Balik Kanan Henti = GERAK!' },
            ]},
            { category: 'Haluan & Melintang', items: [
                { id: 'haluan_kanan_jalan', text: 'Haluan Kanan = JALAN!' },
                { id: 'haluan_kiri_jalan', text: 'Haluan Kiri = JALAN!' },
                { id: 'haluan_kanan_maju_jalan', text: 'Haluan Kanan Maju = JALAN!' },
                { id: 'haluan_kiri_maju_jalan', text: 'Haluan Kiri Maju = JALAN!' },
                { id: 'melintang_kanan_jalan', text: 'Melintang Kanan = JALAN!' },
                { id: 'melintang_kiri_jalan', text: 'Melintang Kiri = JALAN!' },
                { id: 'melintang_kanan_maju_jalan', text: 'Melintang Kanan Maju = JALAN!' },
                { id: 'melintang_kiri_maju_jalan', text: 'Melintang Kiri Maju = JALAN!' },
            ]},
            { category: 'Berhimpun & Berkumpul', items: [
                { id: 'berhimpun_mulai', text: 'Berhimpun = MULAI!' },
                { id: 'bersaf_kumpul_mulai', text: 'Bersaf Kumpul = MULAI!' },
                { id: 'berbanjar_kumpul_mulai', text: 'Berbanjar Kumpul = MULAI!' },
                { id: 'selesai_himpun_kumpul', text: 'SELESAI!' }
            ]}
        ];

        // --- STATE ---
        let plan = { title: '', description: '', posts: [] };
        let currentTargetMaterialId = null;

        // --- DOM ELEMENTS ---
        const postsContainer = document.getElementById('posts-container');
        const addPostBtn = document.getElementById('add-post-btn');
        const planTitleInput = document.getElementById('plan-title');
        const planDescriptionInput = document.getElementById('plan-description');
        const commandModal = document.getElementById('command-modal');
        const modalCommandList = document.getElementById('modal-command-list');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalSearchInput = document.getElementById('modal-search');
        const toastEl = document.getElementById('toast');
        const toastMessageEl = document.getElementById('toast-message');
        
        const playAllBtn = document.getElementById('play-all-btn');
        const copyPlanBtn = document.getElementById('copy-plan-btn');
        const resetPlanBtn = document.getElementById('reset-plan-btn');

        // --- FUNCTIONS ---
        const showToast = (message) => {
            toastMessageEl.textContent = message;
            toastEl.classList.remove('translate-y-24', 'opacity-0');
            toastEl.classList.add('translate-y-0', 'opacity-100');
            setTimeout(() => {
                toastEl.classList.remove('translate-y-0', 'opacity-100');
                toastEl.classList.add('translate-y-24', 'opacity-0');
            }, 3000);
        };

        const renderPlan = () => {
            postsContainer.innerHTML = '';
            if (plan.posts.length === 0) {
                postsContainer.innerHTML = `<div class="text-center py-16 text-slate-500 bg-white rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold">Rencana Masih Kosong</h3>
                    <p class="mt-2">Klik tombol "Tambah Pos Baru" untuk memulai.</p>
                </div>`;
            }
            plan.posts.forEach((post, index) => {
                const postEl = document.createElement('div');
                postEl.className = "bg-white p-6 rounded-2xl shadow-xl";
                postEl.dataset.postId = post.id;
                postEl.innerHTML = `
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl font-bold text-rose-800">POS ${index + 1}</span>
                            <input type="text" value="${post.name}" data-field="name" placeholder="Nama Pos" class="text-xl font-semibold bg-transparent focus:bg-rose-50 rounded p-1">
                        </div>
                        <div class="flex items-center gap-4 text-sm">
                            <div class="flex items-center gap-1">
                                <span class="font-semibold">Ukuran:</span>
                                <input type="text" value="${post.size_p}" data-field="size_p" placeholder="P" class="w-16 p-1 border-b text-center">
                                <span>x</span>
                                <input type="text" value="${post.size_l}" data-field="size_l" placeholder="L" class="w-16 p-1 border-b text-center">
                                <span>m</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="font-semibold">Waktu:</span>
                                <input type="text" value="${post.time}" data-field="time" placeholder="0" class="w-16 p-1 border-b text-center">
                                <span>menit</span>
                            </div>
                        </div>
                        <button class="delete-post-btn text-slate-400 hover:text-red-500 transition-colors" title="Hapus Pos Ini">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                    <hr class="my-4">
                    <div class="materials-container space-y-2"></div>
                    <button class="add-material-row-btn mt-4 text-sm btn-secondary font-semibold py-2 px-4 rounded-lg w-full hover:bg-slate-300">+ Tambah Baris Materi</button>
                `;
                postsContainer.appendChild(postEl);
                renderMaterials(postEl, post);
            });
        };

        const renderMaterials = (postEl, postData) => {
            const materialsContainer = postEl.querySelector('.materials-container');
            materialsContainer.innerHTML = '';
            if (postData.materials.length === 0) {
                materialsContainer.innerHTML = `<p class="text-center text-slate-400 py-4">Belum ada materi.</p>`;
            }
            postData.materials.forEach((material, index) => {
                const materialRow = document.createElement('div');
                materialRow.className = 'material-row group bg-slate-100 p-2 rounded-lg flex items-center gap-3 transition-all duration-300';
                materialRow.dataset.materialId = material.id;

                const movementSpans = material.movements.map((mov, movIndex) => {
                    const command = PBB_COMMANDS.flatMap(c => c.items).find(i => i.id === mov.id);
                    if (!command) return '';
                    
                    let chipHTML = '';
                    if (command.needsInput) {
                        chipHTML = `<input type="text" value="${mov.count || ''}" placeholder="..." class="movement-count-input w-8 text-center bg-transparent font-bold"> ${command.text}`;
                    } else {
                        chipHTML = command.text;
                    }

                    return `<span class="movement-chip bg-white px-3 py-1 rounded-full shadow-sm flex items-center gap-2 text-sm">${chipHTML}<button class="delete-movement-chip-btn text-red-300 hover:text-red-500 font-bold" data-movement-index="${movIndex}">&times;</button></span>`;
                });
                
                const movementHTML = movementSpans.join('<span class="font-bold text-slate-400 mx-1">–</span>');

                materialRow.innerHTML = `
                    <span class="font-bold text-slate-700">${index + 1}.</span>
                    <div class="movements-display flex-grow flex flex-wrap items-center gap-2">
                        ${movementSpans.length > 0 ? movementHTML : '<span class="text-slate-400">Pilih gerakan...</span>'}
                    </div>
                    <button class="add-movement-btn text-rose-500 hover:text-rose-700 hover:bg-rose-100 font-bold text-2xl w-8 h-8 flex items-center justify-center rounded-full transition-colors" title="Tambah Gerakan">+</button>
                    <div class="contextual-controls flex items-center gap-3 border-l pl-3">
                         <label class="flex items-center text-xs text-slate-500 gap-1 cursor-pointer" title="Dilaksanakan oleh Komandan">
                            <input type="checkbox" ${material.commanderExecutes ? 'checked' : ''} class="commander-checkbox rounded text-rose-500 focus:ring-rose-500">
                            Danton
                        </label>
                        <input type="text" value="${material.note || ''}" class="material-note-input w-24 text-xs p-1 border rounded-md" placeholder="Catatan...">
                    </div>
                    <button class="delete-material-btn text-slate-400 hover:text-red-500" title="Hapus Baris">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                `;
                materialsContainer.appendChild(materialRow);
            });
        };
        
        const renderCommandModal = (filter = '') => {
            modalCommandList.innerHTML = '';
            const lowerCaseFilter = filter.toLowerCase();
            PBB_COMMANDS.forEach(category => {
                const filteredItems = category.items.filter(item => item.text.toLowerCase().includes(lowerCaseFilter));
                if (filteredItems.length === 0) return;

                const categoryWrapper = document.createElement('div');
                categoryWrapper.className = 'mb-4';
                categoryWrapper.innerHTML = `<h4 class="text-md font-semibold text-rose-700 mb-2 border-b pb-1">${category.category}</h4>`;
                const itemsWrapper = document.createElement('div');
                itemsWrapper.className = 'grid grid-cols-1 md:grid-cols-2 gap-2';
                
                filteredItems.forEach(item => {
                    const card = document.createElement('button');
                    card.className = 'select-command-btn w-full text-left p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-rose-100 hover:border-rose-400 transition';
                    card.dataset.commandId = item.id;
                    card.textContent = item.text;
                    itemsWrapper.appendChild(card);
                });
                
                categoryWrapper.appendChild(itemsWrapper);
                modalCommandList.appendChild(categoryWrapper);
            });
        };
        
        const openCommandModal = (materialId) => {
            currentTargetMaterialId = materialId;
            renderCommandModal();
            commandModal.classList.remove('hidden');
            commandModal.classList.add('flex');
        };

        const closeCommandModal = () => {
            commandModal.classList.add('hidden');
            commandModal.classList.remove('flex');
            currentTargetMaterialId = null;
            modalSearchInput.value = '';
        };
        
        const copyPlanToClipboard = () => {
            let text = '';
            if (plan.title) text += `${plan.title.toUpperCase()}\n`;
            if (plan.description) text += `${plan.description}\n`;
            if (plan.title || plan.description) text += `\n`;

            plan.posts.forEach((post) => {
                text += `Ukuran Pos ${post.size_p || '-'} X ${post.size_l || '-'} Meter – Waktu ${post.time || '-'} Menit\n\n`;
                
                post.materials.forEach((material, index) => {
                    const movementTexts = material.movements.map(mov => {
                        const command = PBB_COMMANDS.flatMap(c => c.items).find(i => i.id === mov.id);
                        if (!command) return null;
                        let commandText = command.text.replace('!', '');
                        if (command.needsInput && mov.count) {
                            commandText = `${mov.count} ${commandText}`;
                        }
                        return commandText;
                    }).filter(Boolean);

                    let line = movementTexts.join(' – ');

                    if (material.note) line += ` (${material.note})`;
                    if (material.commanderExecutes) line += ' (Dilaksanakan Komandan)';
                    
                    if (line) text += `${index + 1}.\t${line}\n`;
                });
                text += '\n';
            });
            
            navigator.clipboard.writeText(text.trim()).then(() => {
                showToast('Rencana berhasil disalin!');
            }).catch(err => {
                showToast('Gagal menyalin rencana.');
                console.error(err);
            });
        };

        // --- EVENT HANDLERS ---
        planTitleInput.addEventListener('input', (e) => plan.title = e.target.value);
        planDescriptionInput.addEventListener('input', (e) => plan.description = e.target.value);

        addPostBtn.addEventListener('click', () => {
            const newPost = { id: `post_${Date.now()}`, name: '', time: '', size_p: '', size_l: '', materials: [] };
            plan.posts.push(newPost);
            renderPlan();
        });

        resetPlanBtn.addEventListener('click', () => {
            if (confirm('Anda yakin ingin mereset seluruh rencana? Ini akan menghapus semua pos dan materi.')) {
                plan = { title: plan.title, description: plan.description, posts: [] };
                renderPlan();
                showToast('Rencana telah direset.');
            }
        });

        postsContainer.addEventListener('input', (e) => {
            const postId = e.target.closest('[data-post-id]')?.dataset.postId;
            if (!postId) return;
            const post = plan.posts.find(p => p.id === postId);
            if (!post) return;

            const field = e.target.dataset.field;
            if (field) post[field] = e.target.value;

            const materialId = e.target.closest('.material-row')?.dataset.materialId;
            if (materialId) {
                const material = post.materials.find(m => m.id === materialId);
                if (!material) return;
                if (e.target.matches('.commander-checkbox')) material.commanderExecutes = e.target.checked;
                if (e.target.matches('.material-note-input')) material.note = e.target.value;
                if (e.target.matches('.movement-count-input')) {
                    const chip = e.target.closest('.movement-chip');
                    const movementIndex = Array.from(chip.parentElement.children).filter(el => el.classList.contains('movement-chip')).indexOf(chip);
                    if(material.movements[movementIndex]) {
                        material.movements[movementIndex].count = e.target.value;
                    }
                }
            }
        });
        
        postsContainer.addEventListener('click', (e) => {
            const postId = e.target.closest('[data-post-id]')?.dataset.postId;
            if (!postId) return;
            const post = plan.posts.find(p => p.id === postId);
            if (!post) return;
            
            if (e.target.closest('.delete-post-btn')) {
                plan.posts = plan.posts.filter(p => p.id !== postId);
                renderPlan();
                return;
            }
            
            if (e.target.matches('.add-material-row-btn')) {
                const newMaterial = { id: `mat_${Date.now()}`, movements: [], commanderExecutes: false, note: '' };
                post.materials.push(newMaterial);
                renderPlan();
                return;
            }

            const materialRow = e.target.closest('.material-row');
            if (materialRow) {
                const materialId = materialRow.dataset.materialId;
                if (e.target.closest('.add-movement-btn')) {
                    openCommandModal(materialId);
                }
                if (e.target.closest('.delete-material-btn')) {
                    post.materials = post.materials.filter(m => m.id !== materialId);
                    renderPlan();
                }
                const deleteChipBtn = e.target.closest('.delete-movement-chip-btn');
                if (deleteChipBtn) {
                     const movementIndex = parseInt(deleteChipBtn.dataset.movementIndex, 10);
                     const material = post.materials.find(m => m.id === materialId);
                     if (material) {
                         material.movements.splice(movementIndex, 1);
                         renderPlan();
                     }
                }
            }
        });
        
        // Modal events
        modalCloseBtn.addEventListener('click', closeCommandModal);
        modalSearchInput.addEventListener('input', (e) => renderCommandModal(e.target.value));
        modalCommandList.addEventListener('click', (e) => {
            const commandBtn = e.target.closest('.select-command-btn');
            if (commandBtn) {
                const commandId = commandBtn.dataset.commandId;
                const post = plan.posts.find(p => p.materials.some(m => m.id === currentTargetMaterialId));
                if (!post) return;
                const material = post.materials.find(m => m.id === currentTargetMaterialId);
                if (!material) return;
                
                const command = PBB_COMMANDS.flatMap(c => c.items).find(i => i.id === commandId);
                const newMovement = { id: commandId };
                if (command.needsInput) {
                    newMovement.count = '';
                }
                material.movements.push(newMovement);
                
                renderPlan();
                closeCommandModal();
            }
        });
        
        // Global controls
        copyPlanBtn.addEventListener('click', copyPlanToClipboard);
        // Placeholder for playAll, can be implemented later
        playAllBtn.addEventListener('click', () => showToast('Fitur "Putar Semua" sedang dalam pengembangan.'));

        // --- INITIALIZATION ---
        renderPlan();
    });
    </script>
</body>
</html>
